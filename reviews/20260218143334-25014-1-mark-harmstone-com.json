{
  "thread_id": "20260218143334.25014-1-mark@harmstone.com",
  "subject": "[PATCH] btrfs: fix chunk map leaks in btrfs_map_block()",
  "url": "https://lore.kernel.org/all/20260218143334.25014-1-mark@harmstone.com/",
  "dates": {
    "2026-02-18": {
      "report_file": "2026-02-18_ollama_llama3.1-8b.html",
      "developer": "Mark Harmstone",
      "reviews": [
        {
          "author": "Filipe Manana",
          "summary": "Requested splitting the patch into two separate patches, each with its own Fixes tag, to facilitate backporting of the second leak. Suggested adding a Link tag pointing to the public review URL.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "On Wed, Feb 18, 2026 at 2:33â€¯PM Mark Harmstone <mark@harmstone.com> wrote:\n>\n> Fix the two early returns in btrfs_map_block() so that we can no longer\n> fail to put the chunk map after getting it.\n>\n> Signed-off-by: Mark Harmstone <mark@harmstone.com>\n> Reported-by: Chris Mason <clm@fb.com>\n\nSo being a bug fix, this is the type of patch that should have a Fixes tag.\n\nThe commit that introduced the first leak is not in any released\nkernel, so no stable releases are affected.\nHowever it's still useful to have the Fixes tag here, because in case\nsomeone decides to backport the offending commit, either upstream or\ndownstream, there are scripts in place to check if there are newer\ncommits that fix a bug in the former commit and therefore must be\nbackported as well.\n\nBut the second leak was introduced in a much older commit, from 2024,\nand should be backported.\nSe comments inline below.\n\nAlso, since this was reported publicly, please add a Link tag pointing\nto the URL with the review.\n\n> ---\n>  fs/btrfs/volumes.c | 8 +++++---\n>  1 file changed, 5 insertions(+), 3 deletions(-)\n>\n> diff --git a/fs/btrfs/volumes.c b/fs/btrfs/volumes.c\n> index 83e2834ea273..a1f0fccd552c 100644\n> --- a/fs/btrfs/volumes.c\n> +++ b/fs/btrfs/volumes.c\n> @@ -7082,7 +7082,7 @@ int btrfs_map_block(struct btrfs_fs_info *fs_info, enum btrfs_map_op op,\n>\n>                 ret = btrfs_translate_remap(fs_info, &new_logical, length);\n>                 if (ret)\n> -                       return ret;\n> +                       goto out;\n\nFor this hunk:\n\nFixes: 18ba64992871 (\"btrfs: redirect I/O for remapped block groups\")\n\n>\n>                 if (new_logical != logical) {\n>                         btrfs_free_chunk_map(map);\n> @@ -7096,8 +7096,10 @@ int btrfs_map_block(struct btrfs_fs_info *fs_info, enum btrfs_map_op op,\n>         }\n>\n>         num_copies = btrfs_chunk_map_num_copies(map);\n> -       if (io_geom.mirror_num > num_copies)\n> -               return -EINVAL;\n> +       if (io_geom.mirror_num > num_copies) {\n> +               ret = -EINVAL;\n> +               goto out;\n> +       }\n\nFor this hunk:\n\nFixes: 0ae653fbec2b (\"btrfs: reduce chunk_map lookups in btrfs_map_block()\")\n\nI would suggest splitting this into 2 different patches, each one with\nthe respective Fixes tag so that the second leak can be backported\nmore easily.\n\n>\n>         map_offset = logical - map->start;\n>         io_geom.raid56_full_stripe_start = (u64)-1;\n> --\n> 2.52.0\n>\n>\n"
        }
      ],
      "analysis_source": "llm"
    }
  }
}