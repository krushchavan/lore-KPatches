<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Review Comments: [PATCH 0/4] mm: zone lock tracepoint instrumentation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .home-link { margin-bottom: 12px; display: block; }
        .home-link a { color: #0366d6; text-decoration: none; font-size: 0.9em; }
        .home-link a:hover { text-decoration: underline; }

        h1 { font-size: 1.3em; margin-bottom: 2px; color: #1a1a1a; line-height: 1.3; }

        .lore-link { font-size: 0.85em; margin: 4px 0 6px; display: block; }
        .lore-link a { color: #0366d6; text-decoration: none; }
        .lore-link a:hover { text-decoration: underline; }

        .date-range {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 16px;
        }
        .date-range a { color: #0366d6; text-decoration: none; }
        .date-range a:hover { text-decoration: underline; }

        /* thread-node scroll margin so the card isn't clipped at the top */
        .thread-node { scroll-margin-top: 8px; }

        /* ── Patch summary ──────────────────────────────────────────── */
        .patch-summary-block {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 3px solid #4a90d9;
        }
        .patch-summary-label {
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #4a90d9;
            margin-bottom: 4px;
        }
        .patch-summary-text {
            font-size: 0.88em;
            color: #444;
            line-height: 1.55;
        }

        /* ── Thread tree ────────────────────────────────────────────── */
        .thread-tree {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Depth indentation via left border */
        .thread-node { position: relative; }
        .thread-children {
            margin-left: 20px;
            padding-left: 12px;
            border-left: 2px solid #e0e0e0;
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ── Review comment card ────────────────────────────────────── */
        .review-comment {
            background: #fff;
            border-radius: 6px;
            padding: 10px 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            font-size: 0.88em;
        }
        .review-comment-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 5px;
        }
        .review-author {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 0.95em;
        }

        /* Date chip — links back to the daily report */
        .date-chip {
            font-size: 0.75em;
            color: #777;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 1px 7px;
            text-decoration: none;
            white-space: nowrap;
        }
        a.date-chip:hover { background: #e0e8f5; color: #0366d6; }

        .badge {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .inline-review-badge {
            display: inline-block;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 500;
            background: #e3f2fd;
            color: #1565c0;
        }
        .review-tag-badge {
            display: inline-block;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 500;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .analysis-source-badge {
            display: inline-block;
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 0.72em;
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .review-comment-text {
            color: #444;
            line-height: 1.55;
            margin-bottom: 4px;
        }
        .review-comment-signals {
            margin-top: 3px;
            font-size: 0.85em;
            color: #aaa;
            font-style: italic;
        }

        /* ── Collapsible raw body ───────────────────────────────────── */
        .raw-body-toggle {
            margin-top: 5px;
            font-size: 0.85em;
        }
        .raw-body-toggle summary {
            cursor: pointer;
            color: #888;
            padding: 2px 0;
            font-weight: 500;
            font-size: 0.9em;
            list-style: none;
        }
        .raw-body-toggle summary::-webkit-details-marker { display: none; }
        .raw-body-toggle summary::before { content: "▶ "; font-size: 0.7em; }
        .raw-body-toggle[open] summary::before { content: "▼ "; }
        .raw-body-toggle summary:hover { color: #555; }
        .raw-body-text {
            white-space: pre-wrap;
            font-size: 0.95em;
            background: #f8f8f8;
            padding: 8px 10px;
            border-radius: 4px;
            max-height: 360px;
            overflow-y: auto;
            margin-top: 4px;
            line-height: 1.5;
            color: #444;
            border: 1px solid #e8e8e8;
        }

        .no-reviews {
            color: #aaa;
            font-size: 0.85em;
            font-style: italic;
            padding: 8px 0;
        }

        footer {
            text-align: center;
            color: #bbb;
            font-size: 0.78em;
            margin-top: 36px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="home-link"><a href="../index.html">&larr; Back to reports</a></div>
    <h1>[PATCH 0/4] mm: zone lock tracepoint instrumentation</h1>
    <div class="lore-link"><a href="https://lore.kernel.org/all/cover.1770821420.git.d@ilvokhin.com/" target="_blank">View on lore.kernel.org &rarr;</a></div>
    <div class="date-range">Active on: <a href="#2026-02-23">2026-02-23</a> &bull; <a href="#2026-02-20">2026-02-20</a></div>
    <div class="patch-summary-block"><div class="patch-summary-label">Patch summary</div><div class="patch-summary-text">Zone lock contention can significantly impact allocation and reclaim latency, as it is a central synchronization point in the page allocator and reclaim paths. Improved visibility into its behavior is therefore important for diagnosing performance issues in memory-intensive workloads.

On some production workloads at Meta, we have observed noticeable zone lock contention. Deeper analysis of lock holders and waiters is currently difficult with existing instrumentation.

While generic lock contention_begin/contention_end tracepoints cover the slow path, they do not provide sufficient visibility into lock hold times. In particular, the lack of a release-side event makes it difficult to identify long lock holders and correlate them with waiters. As a result, distinguishing between short bursts of contention and pathological long hold times requires additional instrumentation.

This patch series adds dedicated tracepoint instrumentation to zone lock, following the existing mmap_lock tracing model.

The goal is to enable detailed holder/waiter analysis and lock hold time measurements without affecting the fast path when tracing is disabled.

The series is structured as follows:

1. Introduce zone lock wrappers. 2. Mechanically convert zone lock users to the wrappers. 3. Convert compaction to use the wrappers (requires minor restructuring of compact_lock_irqsave()). 4. Add zone lock tracepoints.</div></div>
    <div class="thread-tree">
<div class="thread-node depth-0" id="2026-02-20">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Cheatham, Benjamin</span>
<span class="date-chip">2026-02-20</span>
<span class="inline-review-badge">Inline Review</span>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#6c4b00;background:#ffeeba" title="Analysis source: Heuristic">Heuristic</span>
</div>
<div class="review-comment-text">I think you can improve the flow of this series if reorder as follows: 1. Introduce zone lock wrappers 4. Add zone lock tracepoints 2. Mechanically convert zone lock users to the wrappers 3. Convert compaction to use the wrappers... and possibly squash 1 &amp; 4 (though that might be too big of a patch). It&#x27;s better to introduce the wrappers and their tracepoints together before the reviewer (i.e. me) forgets what was added in patch 1 by the time they get to patch 4.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On 2/11/2026 9:22 AM, Dmitry Ilvokhin wrote:
&gt; Zone lock contention can significantly impact allocation and
&gt; reclaim latency, as it is a central synchronization point in
&gt; the page allocator and reclaim paths. Improved visibility into
&gt; its behavior is therefore important for diagnosing performance
&gt; issues in memory-intensive workloads.
&gt; 
&gt; On some production workloads at Meta, we have observed noticeable
&gt; zone lock contention. Deeper analysis of lock holders and waiters
&gt; is currently difficult with existing instrumentation.
&gt; 
&gt; While generic lock contention_begin/contention_end tracepoints
&gt; cover the slow path, they do not provide sufficient visibility
&gt; into lock hold times. In particular, the lack of a release-side
&gt; event makes it difficult to identify long lock holders and
&gt; correlate them with waiters. As a result, distinguishing between
&gt; short bursts of contention and pathological long hold times
&gt; requires additional instrumentation.
&gt; 
&gt; This patch series adds dedicated tracepoint instrumentation to
&gt; zone lock, following the existing mmap_lock tracing model.
&gt; 
&gt; The goal is to enable detailed holder/waiter analysis and lock
&gt; hold time measurements without affecting the fast path when
&gt; tracing is disabled.
&gt; 
&gt; The series is structured as follows:
&gt; 
&gt;   1. Introduce zone lock wrappers.
&gt;   2. Mechanically convert zone lock users to the wrappers.
&gt;   3. Convert compaction to use the wrappers (requires minor
&gt;      restructuring of compact_lock_irqsave()).
&gt;   4. Add zone lock tracepoints.

I think you can improve the flow of this series if reorder as follows:
	1. Introduce zone lock wrappers
	4. Add zone lock tracepoints
	2. Mechanically convert zone lock users to the wrappers
	3. Convert compaction to use the wrappers...

and possibly squash 1 &amp; 4 (though that might be too big of a patch). It&#x27;s better to introduce the
wrappers and their tracepoints together before the reviewer (i.e. me) forgets what was added in
patch 1 by the time they get to patch 4.

Thanks,
Ben
</pre>
</details>
</div>
</div>
<div class="thread-node depth-0">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Shakeel Butt</span>
<span class="date-chip">2026-02-20</span>
<span class="inline-review-badge">Inline Review</span>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#6c4b00;background:#ffeeba" title="Analysis source: Heuristic">Heuristic</span>
</div>
<div class="review-comment-text">I don&#x27;t think this suggestion will make anything better. This just seems like a different taste. If I make a suggestion, I would request to squash (1) and (2) i.e. patch containing wrappers and their use together but that is just my taste and would be a nit. The series ordering is good as is.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On Fri, Feb 20, 2026 at 01:09:59PM -0600, Cheatham, Benjamin wrote:
&gt; On 2/11/2026 9:22 AM, Dmitry Ilvokhin wrote:
&gt; &gt; Zone lock contention can significantly impact allocation and
&gt; &gt; reclaim latency, as it is a central synchronization point in
&gt; &gt; the page allocator and reclaim paths. Improved visibility into
&gt; &gt; its behavior is therefore important for diagnosing performance
&gt; &gt; issues in memory-intensive workloads.
&gt; &gt; 
&gt; &gt; On some production workloads at Meta, we have observed noticeable
&gt; &gt; zone lock contention. Deeper analysis of lock holders and waiters
&gt; &gt; is currently difficult with existing instrumentation.
&gt; &gt; 
&gt; &gt; While generic lock contention_begin/contention_end tracepoints
&gt; &gt; cover the slow path, they do not provide sufficient visibility
&gt; &gt; into lock hold times. In particular, the lack of a release-side
&gt; &gt; event makes it difficult to identify long lock holders and
&gt; &gt; correlate them with waiters. As a result, distinguishing between
&gt; &gt; short bursts of contention and pathological long hold times
&gt; &gt; requires additional instrumentation.
&gt; &gt; 
&gt; &gt; This patch series adds dedicated tracepoint instrumentation to
&gt; &gt; zone lock, following the existing mmap_lock tracing model.
&gt; &gt; 
&gt; &gt; The goal is to enable detailed holder/waiter analysis and lock
&gt; &gt; hold time measurements without affecting the fast path when
&gt; &gt; tracing is disabled.
&gt; &gt; 
&gt; &gt; The series is structured as follows:
&gt; &gt; 
&gt; &gt;   1. Introduce zone lock wrappers.
&gt; &gt;   2. Mechanically convert zone lock users to the wrappers.
&gt; &gt;   3. Convert compaction to use the wrappers (requires minor
&gt; &gt;      restructuring of compact_lock_irqsave()).
&gt; &gt;   4. Add zone lock tracepoints.
&gt; 
&gt; I think you can improve the flow of this series if reorder as follows:
&gt; 	1. Introduce zone lock wrappers
&gt; 	4. Add zone lock tracepoints
&gt; 	2. Mechanically convert zone lock users to the wrappers
&gt; 	3. Convert compaction to use the wrappers...
&gt; 
&gt; and possibly squash 1 &amp; 4 (though that might be too big of a patch). It&#x27;s better to introduce the
&gt; wrappers and their tracepoints together before the reviewer (i.e. me) forgets what was added in
&gt; patch 1 by the time they get to patch 4.

I don&#x27;t think this suggestion will make anything better. This just seems like a
different taste. If I make a suggestion, I would request to squash (1) and (2)
i.e. patch containing wrappers and their use together but that is just my taste
and would be a nit. The series ordering is good as is.

</pre>
</details>
</div>
</div>
<div class="thread-node depth-0" id="2026-02-23">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Dmitry Ilvokhin (author)</span>
<span class="date-chip">2026-02-23</span>
<span class="inline-review-badge">Inline Review</span>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#6c4b00;background:#ffeeba" title="Analysis source: Heuristic">Heuristic</span>
</div>
<div class="review-comment-text">I structured the series intentionally to keep all behavior-preserving refactoring separate from the actual instrumentation change. In particular, I had to split the conversion into two patches to separate the purely mechanical changes from the compaction restructuring. With the current order, tracepoints addition remains a single, atomic functional change on top of a fully converted tree. This keeps the instrumentation isolated from the refactoring and with an intention to make bisection and review of the behavioral change easier. Reordering as suggested would mix instrumentation with intermediate refactoring states, which I&#x27;d prefer to avoid. I hope this reasoning makes sense, but I&#x27;m happy to discuss if there are strong objections.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On Fri, Feb 20, 2026 at 01:09:59PM -0600, Cheatham, Benjamin wrote:
&gt; On 2/11/2026 9:22 AM, Dmitry Ilvokhin wrote:
&gt; &gt; Zone lock contention can significantly impact allocation and
&gt; &gt; reclaim latency, as it is a central synchronization point in
&gt; &gt; the page allocator and reclaim paths. Improved visibility into
&gt; &gt; its behavior is therefore important for diagnosing performance
&gt; &gt; issues in memory-intensive workloads.
&gt; &gt; 
&gt; &gt; On some production workloads at Meta, we have observed noticeable
&gt; &gt; zone lock contention. Deeper analysis of lock holders and waiters
&gt; &gt; is currently difficult with existing instrumentation.
&gt; &gt; 
&gt; &gt; While generic lock contention_begin/contention_end tracepoints
&gt; &gt; cover the slow path, they do not provide sufficient visibility
&gt; &gt; into lock hold times. In particular, the lack of a release-side
&gt; &gt; event makes it difficult to identify long lock holders and
&gt; &gt; correlate them with waiters. As a result, distinguishing between
&gt; &gt; short bursts of contention and pathological long hold times
&gt; &gt; requires additional instrumentation.
&gt; &gt; 
&gt; &gt; This patch series adds dedicated tracepoint instrumentation to
&gt; &gt; zone lock, following the existing mmap_lock tracing model.
&gt; &gt; 
&gt; &gt; The goal is to enable detailed holder/waiter analysis and lock
&gt; &gt; hold time measurements without affecting the fast path when
&gt; &gt; tracing is disabled.
&gt; &gt; 
&gt; &gt; The series is structured as follows:
&gt; &gt; 
&gt; &gt;   1. Introduce zone lock wrappers.
&gt; &gt;   2. Mechanically convert zone lock users to the wrappers.
&gt; &gt;   3. Convert compaction to use the wrappers (requires minor
&gt; &gt;      restructuring of compact_lock_irqsave()).
&gt; &gt;   4. Add zone lock tracepoints.
&gt; 
&gt; I think you can improve the flow of this series if reorder as follows:
&gt; 	1. Introduce zone lock wrappers
&gt; 	4. Add zone lock tracepoints
&gt; 	2. Mechanically convert zone lock users to the wrappers
&gt; 	3. Convert compaction to use the wrappers...
&gt; 
&gt; and possibly squash 1 &amp; 4 (though that might be too big of a patch). It&#x27;s better to introduce the
&gt; wrappers and their tracepoints together before the reviewer (i.e. me) forgets what was added in
&gt; patch 1 by the time they get to patch 4.

Hi Ben,

Thanks for the suggestion.

I structured the series intentionally to keep all behavior-preserving
refactoring separate from the actual instrumentation change.

In particular, I had to split the conversion into two patches to
separate the purely mechanical changes from the compaction
restructuring. With the current order, tracepoints addition remains a
single, atomic functional change on top of a fully converted tree. This
keeps the instrumentation isolated from the refactoring and with an
intention to make bisection and review of the behavioral change easier.

Reordering as suggested would mix instrumentation with intermediate
refactoring states, which I&#x27;d prefer to avoid.

I hope this reasoning makes sense, but I&#x27;m happy to discuss if there are
strong objections.

&gt; 
&gt; Thanks,
&gt; Ben
</pre>
</details>
</div>
</div>
<div class="thread-node depth-0">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Cheatham, Benjamin</span>
<span class="date-chip">2026-02-23</span>
<span class="inline-review-badge">Inline Review</span>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#6c4b00;background:#ffeeba" title="Analysis source: Heuristic">Heuristic</span>
</div>
<div class="review-comment-text">No that&#x27;s fine, I figured as much. I just wasn&#x27;t sure that was more important to you than what (I thought) was a better reading order for the series.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">

On 2/23/2026 10:46 AM, Dmitry Ilvokhin wrote:
&gt; [You don&#x27;t often get email from d@ilvokhin.com. Learn why this is important at https://aka.ms/LearnAboutSenderIdentification ]
&gt; 
&gt; On Fri, Feb 20, 2026 at 01:09:59PM -0600, Cheatham, Benjamin wrote:
&gt;&gt; On 2/11/2026 9:22 AM, Dmitry Ilvokhin wrote:
&gt;&gt;&gt; Zone lock contention can significantly impact allocation and
&gt;&gt;&gt; reclaim latency, as it is a central synchronization point in
&gt;&gt;&gt; the page allocator and reclaim paths. Improved visibility into
&gt;&gt;&gt; its behavior is therefore important for diagnosing performance
&gt;&gt;&gt; issues in memory-intensive workloads.
&gt;&gt;&gt;
&gt;&gt;&gt; On some production workloads at Meta, we have observed noticeable
&gt;&gt;&gt; zone lock contention. Deeper analysis of lock holders and waiters
&gt;&gt;&gt; is currently difficult with existing instrumentation.
&gt;&gt;&gt;
&gt;&gt;&gt; While generic lock contention_begin/contention_end tracepoints
&gt;&gt;&gt; cover the slow path, they do not provide sufficient visibility
&gt;&gt;&gt; into lock hold times. In particular, the lack of a release-side
&gt;&gt;&gt; event makes it difficult to identify long lock holders and
&gt;&gt;&gt; correlate them with waiters. As a result, distinguishing between
&gt;&gt;&gt; short bursts of contention and pathological long hold times
&gt;&gt;&gt; requires additional instrumentation.
&gt;&gt;&gt;
&gt;&gt;&gt; This patch series adds dedicated tracepoint instrumentation to
&gt;&gt;&gt; zone lock, following the existing mmap_lock tracing model.
&gt;&gt;&gt;
&gt;&gt;&gt; The goal is to enable detailed holder/waiter analysis and lock
&gt;&gt;&gt; hold time measurements without affecting the fast path when
&gt;&gt;&gt; tracing is disabled.
&gt;&gt;&gt;
&gt;&gt;&gt; The series is structured as follows:
&gt;&gt;&gt;
&gt;&gt;&gt;   1. Introduce zone lock wrappers.
&gt;&gt;&gt;   2. Mechanically convert zone lock users to the wrappers.
&gt;&gt;&gt;   3. Convert compaction to use the wrappers (requires minor
&gt;&gt;&gt;      restructuring of compact_lock_irqsave()).
&gt;&gt;&gt;   4. Add zone lock tracepoints.
&gt;&gt;
&gt;&gt; I think you can improve the flow of this series if reorder as follows:
&gt;&gt;       1. Introduce zone lock wrappers
&gt;&gt;       4. Add zone lock tracepoints
&gt;&gt;       2. Mechanically convert zone lock users to the wrappers
&gt;&gt;       3. Convert compaction to use the wrappers...
&gt;&gt;
&gt;&gt; and possibly squash 1 &amp; 4 (though that might be too big of a patch). It&#x27;s better to introduce the
&gt;&gt; wrappers and their tracepoints together before the reviewer (i.e. me) forgets what was added in
&gt;&gt; patch 1 by the time they get to patch 4.
&gt; 
&gt; Hi Ben,
&gt; 
&gt; Thanks for the suggestion.
&gt; 
&gt; I structured the series intentionally to keep all behavior-preserving
&gt; refactoring separate from the actual instrumentation change.
&gt; 
&gt; In particular, I had to split the conversion into two patches to
&gt; separate the purely mechanical changes from the compaction
&gt; restructuring. With the current order, tracepoints addition remains a
&gt; single, atomic functional change on top of a fully converted tree. This
&gt; keeps the instrumentation isolated from the refactoring and with an
&gt; intention to make bisection and review of the behavioral change easier.
&gt; 
&gt; Reordering as suggested would mix instrumentation with intermediate
&gt; refactoring states, which I&#x27;d prefer to avoid.
&gt; 
&gt; I hope this reasoning makes sense, but I&#x27;m happy to discuss if there are
&gt; strong objections.

No that&#x27;s fine, I figured as much. I just wasn&#x27;t sure that was more important
to you than what (I thought) was a better reading order for the series.

Thanks,
Ben

&gt; 
&gt;&gt;
&gt;&gt; Thanks,
&gt;&gt; Ben

</pre>
</details>
</div>
</div>
</div>

    <footer>LKML Daily Activity Tracker</footer>
    <script>
    // When arriving via a date anchor (e.g. #2026-02-15 from a daily report),
    // scroll the anchor into view after a brief delay so layout is complete.
    (function () {
        var hash = window.location.hash;
        if (!hash) return;
        var target = document.getElementById(hash.slice(1));
        if (!target) return;
        setTimeout(function () {
            target.scrollIntoView({behavior: 'smooth', block: 'start'});
        }, 80);
    })();
    </script>
</body>
</html>