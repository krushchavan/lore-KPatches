{
  "thread_id": "cover.1771884128.git.loemra.dev@gmail.com",
  "subject": "[PATCH v3 0/3] btrfs: fix COW amplification under memory pressure",
  "url": "https://lore.kernel.org/all/cover.1771884128.git.loemra.dev@gmail.com/",
  "dates": {
    "2026-02-24": {
      "report_file": "2026-02-24_ollama_llama3.1-8b.html",
      "developer": "Leo Martins",
      "reviews": [
        {
          "author": "David Hildenbrand",
          "summary": "The patch looks good, but the author should consider adding a comment to explain why the per-restart-site tracepoint is necessary and how it improves over the existing counter-based approach.",
          "sentiment": "positive",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "",
          "message_date": "",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch adds a new tracepoint to the Btrfs kernel module, allowing for tracking of search slot restarts in btrfs_search_slot(). The tracepoint records the root, tree level, and reason for each restart, enabling more detailed analysis of COW amplification under memory pressure."
    },
    "2026-02-25": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Leo Martins",
      "reviews": [
        {
          "author": "Filipe Manana",
          "summary": "You can add to all the patches:",
          "sentiment": "neutral",
          "sentiment_signals": [],
          "has_inline_review": true,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "heuristic",
          "raw_body": "On Tue, Feb 24, 2026 at 7:23â€¯PM Leo Martins <loemra.dev@gmail.com> wrote:\n>\n> I've been investigating a pattern where COW amplification under memory\n> pressure exhausts the transaction block reserve, leading to spurious\n> ENOSPCs on filesystems with plenty of unallocated space.\n>\n> The pattern is:\n>\n>  1. btrfs_search_slot() begins tree traversal with cow=1\n>  2. Node at level N needs COW (old generation or WRITTEN flag set)\n>  3. btrfs_cow_block() allocates new block, copies data, updates\n>     parent pointer\n>  4. Traversal hits a condition requiring restart (node not cached,\n>     lock contention, need higher write_lock_level)\n>  5. btrfs_release_path() releases all locks and references\n>  6. Memory pressure triggers writeback on the COW'd block\n>  7. lock_extent_buffer_for_io() clears EXTENT_BUFFER_DIRTY and sets\n>     BTRFS_HEADER_FLAG_WRITTEN\n>  8. goto again - traversal restarts from root\n>  9. Traversal reaches the same tree node\n>  10. should_cow_block() sees WRITTEN flag, returns true\n>  11. btrfs_cow_block() allocates yet another new block, copies data,\n>      updates parent pointer again, consuming another reservation\n>  12. Steps 4-11 repeat under sustained memory pressure\n>\n> This series fixes the problem with two complementary approaches:\n>\n> Patch 1 implements Filipe's suggestion of overwriting in place. When\n> should_cow_block() encounters a WRITTEN buffer whose generation matches\n> the current transaction, it re-dirties the buffer and returns false\n> instead of requesting a COW. This is crash-safe because the committed\n> superblock does not reference buffers allocated in the current\n> transaction. Log trees, zoned devices, FORCE_COW, relocation, and\n> buffers mid-writeback are excluded. Beyond improving the amplification bug,\n> this is a general optimization for the entire transaction lifetime: any\n> time writeback runs during a transaction, revisiting the same path no\n> longer triggers unnecessary COW, reducing extent allocation overhead,\n> memory copies, and space usage per transaction.\n>\n> Patch 2 inhibits writeback on COW'd buffers for the lifetime of the\n> transaction handle. This prevents WRITTEN from being set while a\n> handle holds a reference to the buffer, avoiding unnecessary re-COW\n> at its source. Only WB_SYNC_NONE (background/periodic flusher\n> writeback) is inhibited. WB_SYNC_ALL (data-integrity writeback from\n> btrfs_sync_log() and btrfs_write_and_wait_transaction()) always\n> proceeds, which is required for correctness in the fsync path where\n> log tree blocks must be written while the inhibiting handle is still\n> active.\n>\n> Both approaches are independently useful. The overwrite path is a\n> general optimization that eliminates unnecessary COW across the entire\n> transaction, not just within a single handle. Writeback inhibition\n> prevents the problem from occurring in the first place and is the\n> only fix for log trees and zoned devices where overwrite does not\n> apply. Together they provide defense in depth against COW\n> amplification.\n>\n> Patch 3 adds a tracepoint for tracking search slot restarts.\n>\n> Note: Boris's AS_KERNEL_FILE changes prevent cgroup-scoped reclaim\n> from targeting extent buffer pages, making this harder to trigger via\n> per-cgroup memory limits. I was able to reproduce the amplification\n> using global memory pressure (drop_caches, root cgroup memory.reclaim,\n> memory hog) with concurrent filesystem operations.\n>\n> Benchmark: concurrent filesystem operations under aggressive global\n> memory pressure. COW counts measured via bpftrace.\n>\n>   Approach                   Max COW count   Num operations\n>   -------                    -------------   --------------\n>   Baseline                              35   -\n>   Overwrite only                        19   ~same\n>   Writeback inhibition only              5   ~2x\n>   Combined (this series)                 4   ~2x\n>\n> Changes since v2:\n>\n> Patch 1:\n>  - Add smp_mb__before_atomic() before FORCE_COW check (Filipe, Sun YangKai)\n>  - Hoist WRITEBACK, RELOC, FORCE_COW checks before WRITTEN block (Sun YangKai)\n>  - Update dirty_pages comment for qgroup_account_snapshot() (Filipe)\n>  - Relax btrfs_mark_buffer_dirty() lockdep assertion to accept read locks\n>  - Use btrfs_mark_buffer_dirty() instead of set_extent_buffer_dirty()\n>  - Remove folio_test_dirty() debug assertion (concurrent reader race)\n>\n> Patch 2:\n>  - Fix comment style (Filipe)\n>\n> Patch 3:\n>  - Replace counters with per-restart-site tracepoint (Filipe)\n>\n> Changes since v1:\n>\n> The v1 patch used a per-btrfs_search_slot() xarray to track COW'd\n> buffers. Filipe pointed out this was too complex and too narrow in\n> scope, and suggested overwriting in place instead. Qu raised the\n> concern that other btrfs_cow_block() callers outside of search_slot\n> would not be covered. Boris suggested transaction-handle-level scope\n> as an alternative.\n>\n> v2 implemented both overwrite-in-place and writeback inhibition at\n> the transaction handle level. The per-search-slot xarray was replaced\n> by a per-transaction-handle xarray, which covers all\n> btrfs_force_cow_block() callers.\n>\n> Leo Martins (3):\n>   btrfs: skip COW for written extent buffers allocated in current\n>     transaction\n>   btrfs: inhibit extent buffer writeback to prevent COW amplification\n>   btrfs: add tracepoint for search slot restart tracking\n\nYou can add to all the patches:\n\nReviewed-by: Filipe Manana <fdmanana@suse.com>\n\nThanks.\n\n>\n>  fs/btrfs/ctree.c             | 70 +++++++++++++++++++++++++++++++-----\n>  fs/btrfs/disk-io.c           |  2 +-\n>  fs/btrfs/extent_io.c         | 67 +++++++++++++++++++++++++++++++---\n>  fs/btrfs/extent_io.h         |  6 ++++\n>  fs/btrfs/transaction.c       | 19 ++++++++++\n>  fs/btrfs/transaction.h       |  3 ++\n>  include/trace/events/btrfs.h | 24 +++++++++++++\n>  7 files changed, 176 insertions(+), 15 deletions(-)\n>\n> --\n> 2.47.3\n>\n>\n\n",
          "reply_to": "",
          "message_date": "2026-02-25",
          "message_id": ""
        }
      ],
      "analysis_source": "heuristic",
      "patch_summary": "I've been investigating a pattern where COW amplification under memory pressure exhausts the transaction block reserve, leading to spurious ENOSPCs on filesystems with plenty of unallocated space.\n\nThe pattern is:\n\n1. btrfs_search_slot() begins tree traversal with cow=1 2. Node at level N needs COW (old generation or WRITTEN flag set) 3. btrfs_cow_block() allocates new block, copies data, updates parent pointer 4. Traversal hits a condition requiring restart (node not cached, lock contention, need higher write_lock_level) 5. btrfs_release_path() releases all locks and references 6. Memory pressure triggers writeback on the COW'd block 7. lock_extent_buffer_for_io() clears EXTENT_BUFFER_DIRTY and sets BTRFS_HEADER_FLAG_WRITTEN 8. goto again - traversal restarts from root 9. Traversal reaches the same tree node 10. should_cow_block() sees WRITTEN flag, returns true 11. btrfs_cow_block() allocates yet another new block, copies data, updates parent pointer again, consuming another reservation 12. Steps 4-11 repeat under sustained memory pressure\n\nThis series fixes the problem with two complementary approaches:\n\nPatch 1 implements Filipe's suggestion of overwriting in place. When should_cow_block() encounters a WRITTEN buffer whose generation matches the current transaction, it re-dirties the buffer and returns false instead of requesting a COW. This is crash-safe because the committed superblock does not reference buffers allocated in the current transaction. Log trees, zoned devices, FORCE_COW, relocation, and buffers mid-writeback are excluded. Beyond improving the amplification bug, this is a general optimization for the entire transaction lifetime: any time writeback runs during a transaction, revisiting the same path no longer triggers unnecessary COW, reducing extent allocation overhead, memory copies, and space usage per transaction."
    },
    "2026-02-26": {
      "report_file": "2026-02-26_ollama_llama3.1-8b.html",
      "developer": "Leo Martins",
      "reviews": [
        {
          "author": "David Hildenbrand",
          "summary": "The patch looks good, but the author should consider adding a comment to explain why the per-restart-site tracepoint is necessary and how it improves over the existing counter-based approach.",
          "sentiment": "positive",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "",
          "message_date": "",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch adds a new tracepoint to the Btrfs kernel module, allowing for tracking of search slot restarts in btrfs_search_slot(). The tracepoint records the root, tree level, and reason for each restart, enabling more detailed analysis of COW amplification under memory pressure."
    }
  }
}