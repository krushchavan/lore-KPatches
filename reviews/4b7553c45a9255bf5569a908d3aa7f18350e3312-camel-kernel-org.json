{
  "thread_id": "4b7553c45a9255bf5569a908d3aa7f18350e3312.camel@kernel.org",
  "subject": "[PATCH v2 1/1] NFSD: move accumulated callback ops to per-net namespace",
  "url": "https://lore.kernel.org/all/4b7553c45a9255bf5569a908d3aa7f18350e3312.camel@kernel.org/",
  "dates": {
    "2026-02-25": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Jeff Layton",
      "reviews": [
        {
          "author": "Jeff Layton",
          "summary": "Identified a double-put bug where nrvers was incorrectly calculated due to an out-of-date code snippet. Suggested using ARRAY_SIZE(nn->nfsd_cb_versions) instead.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "",
          "message_date": "",
          "message_id": ""
        },
        {
          "author": "Dai Ngo",
          "summary": "Confirmed the bug and suggested that it be fixed in version 3.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "\nOn 2/25/26 4:40 AM, Jeff Layton wrote:\n> I had Claude take a look and it came up with this:\n>\n> Moves the callback RPC program, version, and stats structures from\n> global statics into struct nfsd_net so that each network namespace\n> gets its own callback counters and program definition.\n\nClause describes it much more precise than I did, pretty soon I'll\nbe out a job :). Fix in v3.\n\n>\n>> diff --git a/fs/nfsd/nfs4callback.c b/fs/nfsd/nfs4callback.c\n>> index aea8bdd2fdc49..aad4276b2f1bc 100644\n>> --- a/fs/nfsd/nfs4callback.c\n>> +++ b/fs/nfsd/nfs4callback.c\n> [ ... ]\n>\n>> +int nfsd_net_cb_stats_init(struct nfsd_net *nn)\n>> +{\n>> +     nn->nfsd_cb_version4.counts = kzalloc_objs(unsigned int,\n>> +                     ARRAY_SIZE(nfs4_cb_procedures), GFP_KERNEL);\n>> +     if (!nn->nfsd_cb_version4.counts)\n>> +             return -ENOMEM;\n> [ ... ]\n>\n>> +     nn->nfsd_cb_program.name = \"nfs4_cb\";\n>> +     nn->nfsd_cb_program.number = NFS4_CALLBACK;\n>> +     nn->nfsd_cb_program.nrvers = sizeof(struct rpc_version *) * 2;\n>                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n>\n> Should this be ARRAY_SIZE(nn->nfsd_cb_versions) instead?  The nrvers\n> field is documented as \"number of versions\" in struct rpc_program.\n> The old code used ARRAY_SIZE(nfs_cb_version) which evaluated to 2.\n>\n> sizeof(struct rpc_version *) is 8 on 64-bit, making nrvers 16 here\n> while the nfsd_cb_versions array only has 2 elements.  The version\n> bounds check in rpc_new_client() compares args->version against\n> program->nrvers, and rpc_proc_show() iterates from 0 to nrvers - 1\n> accessing program->version[i].\n\nYes, it's a bug. Fix in v3.\n\nThanks,\n-Dai\n\n>\n>> +     nn->nfsd_cb_program.version = &nn->nfsd_cb_versions[0];\n>> +     nn->nfsd_cb_program.pipe_dir_name = \"nfsd4_cb\";\n>> +     nn->nfsd_cb_program.stats = &nn->nfsd_cb_stat;\n>> +     nn->nfsd_cb_stat.program = &nn->nfsd_cb_program;\n>> +\n>> +     return 0;\n>> +}\n>                                                                                 \n\n",
          "reply_to": "Jeff Layton",
          "message_date": "2026-02-25",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "The patch moves accumulated callback operations to per-net namespace, addressing a bug where the nrvers field was incorrectly calculated."
    }
  }
}