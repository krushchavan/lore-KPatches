{
  "thread_id": "aZ5TfEeqULEGXo4N@gourry-fedora-PF4VCD3F",
  "subject": "[PATCH 1/2] cxl/region: fix region leak when attach_target fails in cxl_add_to_region",
  "url": "https://lore.kernel.org/all/aZ5TfEeqULEGXo4N@gourry-fedora-PF4VCD3F/",
  "dates": {
    "2026-02-20": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Gregory Price (author)",
          "summary": "Author addressed a concern about device_attach() being called on auto-discovered regions when a custom attach callback is present. They explained that this can lead to dax memory being left online due to dax_kmem refusing to offline during its remove path. The author agreed to skip device_attach() in such cases, with the custom attach callback responsible for setting up the region afterwards.",
          "sentiment": "needs_work",
          "sentiment_signals": [],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "When a CXL memdev has a custom attach callback, cxl_add_to_region()\nshould not call device_attach() on the auto-discovered region.\n\nThe default device_attach() binds the dax driver, which may online\nmemory via dax_kmem.  The custom attach callback then has to tear down\nthe dax stack to convert the region to sysram, but dax_kmem refuses to\noffline memory during its remove path, leaving regions stuck online.\n\nSkip device_attach() when cxlmd->attach is set.  The attach callback\nis responsible for setting up the region after auto-discovery completes\n(e.g. adding it as sysram directly).\n\nSigned-off-by: Gregory Price <gourry@gourry.net>\n---\n drivers/cxl/core/region.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\ndiff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c\nindex 276046d49f88..e5edeabd9262 100644\n--- a/drivers/cxl/core/region.c\n+++ b/drivers/cxl/core/region.c\n@@ -3971,6 +3971,12 @@ int cxl_add_to_region(struct cxl_endpoint_decoder *cxled)\n \t}\n \n \tif (attach) {\n+\t\tstruct cxl_memdev *cxlmd = cxled_to_memdev(cxled);\n+\n+\t\t/* Skip device_attach if memdev has is own attach callback */\n+\t\tif (cxlmd->attach)\n+\t\t\treturn 0;\n+\n \t\t/*\n \t\t * If device_attach() fails the range may still be active via\n \t\t * the platform-firmware memory map, otherwise the driver for\n-- \n2.47.3",
          "reply_to": "",
          "message_date": "2026-02-20",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a region leak in the CXL driver when attaching a target fails. When `attach_target` returns an error, the auto-discovered region remains registered and consumes HPA resources without ever reaching a committed state. The patch tracks whether the region was created by checking the return value of `cxl_add_to_region`, and if it was not created successfully, it calls `drop_region` to unregister the region and release the HPA resource. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    },
    "2026-02-21": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Gregory Price (author)",
          "summary": "Author is pushing back against the review, indicating that the patch should be disregarded because it uses a function introduced by another developer, and instead pointing to an alternative solution.",
          "sentiment": "contentious",
          "sentiment_signals": [
            "pushing back",
            "disregard this patch"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "BAH - disregard this patch, it uses drop_region which is introduced by\nAlejandro here:\n\nhttps://lore.kernel.org/linux-cxl/20260201155438.2664640-20-alejandro.lucero-palau@amd.com/",
          "reply_to": "",
          "message_date": "2026-02-21",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a region leak in the CXL driver when attaching a target fails. When `attach_target` returns an error, the auto-discovered region remains registered and consumes HPA resources without ever reaching a committed state. The patch tracks whether the region was created by checking the return value of `cxl_add_to_region`, and if it was not created successfully, it calls `drop_region` to unregister the region and release the HPA resource. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    },
    "2026-02-23": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Alison Schofield",
          "summary": "Reviewer noted that the patch's current implementation drops the region only when attach_target() fails immediately after creation, but not if it fails later in the process, and suggested revisiting a previous patch that unregisters auto-created regions on assembly failure.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "I see you dropping this, perhaps just for the moment, because\nthe drop_region() you wanted to use is not available yet.\n\nThis looks a lot like \n\thttps://lore.kernel.org/linux-cxl/2a613604c0cdda6d9f838ae9b47ea6d936c5e4ce.1769746294.git.alison.schofield@intel.com/\n\tcxl/region: Unregister auto-created region when assembly fails\n\tWhen auto-created region assembly fails the region remains registered\n\tbut disabled. The region continues to reserve its memory resource,\n\tpreventing DAX from registering the memory.\n\tUnregister the region on assembly failure to release the resource.\n\nAnd the review comments on that one, or at least on that thread in\ngeneral, was to leave all the broken things in place.\nI didn't agree with that, and hope to see this version move ahead\nwhen you have the drop_region you need.\n\n-- Alison",
          "reply_to": "Gregory Price",
          "message_date": "2026-02-23",
          "message_id": ""
        },
        {
          "author": "Gregory Price (author)",
          "summary": "Author acknowledged that the patch is not currently useful due to lack of usage, but did not commit to revising or removing it.\n\nThe author acknowledged that the patch addresses a specific issue related to auto-regions and manually created regions in a narrow failure scenario where two devices unbind/bind cycle at the same time, but emphasized it's a rare occurrence.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "acknowledged a limitation",
            "did not promise a fix",
            "acknowledged",
            "emphasized"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Yeah it's not a particularly useful cleanup in the current\ninfrastructure because nothing actually uses this pattern (yet).\n\n---\n\nThe important note here is the difference between auto-regions and\nmanually created regions.  For auto-regions, you might have another\nendpoint show up looking for the partially created region - and then\njust go off and create it anyway because it thinks it was first.\n\nBut in my driver, i'm explicitly converting these auto-regions into\nother things, and if that fails it causes *all other* region creation to\nfail - even if it wasn't actually dependent on that original region.\n\nThis is only an issue if you have two devices unbind/bind cycling at\nthe same time - i.e.\n\n   echo 0000:d0:00.00 > cxl_pci/unbind\n   echo 0000:e0:00.00 > cxl_pci/unbind\n   echo 0000:d0:00.00 > mydriver/bind\n   echo 0000:e0:00.00 > mydriver/bind\n\nIf the platform has pre-programmed and locked the decoders, and one of\nthe two devices fails to probe and leaves a hanging partially\ncreated region, the other device will fail too.\n\nIt's a pretty narrow failure scenario.\n\n~Gregory",
          "reply_to": "Alison Schofield",
          "message_date": "2026-02-23",
          "message_id": ""
        },
        {
          "author": "Alison Schofield",
          "summary": "Reviewer noted that the patch's fix will eventually lead to another failure due to a similar issue, and requested clarification on why this specific case is handled differently.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes",
            "clarification needed"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "That's by design, and that'll eventually fail too.\n\nBut - is see how your case is different. Thanks for the explanation.",
          "reply_to": "Gregory Price",
          "message_date": "2026-02-23",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a region leak in the CXL driver when attaching a target fails. When `attach_target` returns an error, the auto-discovered region remains registered and consumes HPA resources without ever reaching a committed state. The patch tracks whether the region was created by checking the return value of `cxl_add_to_region`, and if it was not created successfully, it calls `drop_region` to unregister the region and release the HPA resource. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    },
    "2026-02-24": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Alejandro Palau",
          "summary": "Reviewer noted that the fix is good but may not provide sufficient debugging/tracing information in case of failure, and suggested further work on the region creation changes",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "further work required",
            "debugging/tracing"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "Feel free to add it to this series. I have started to send individual \nseries as you know but the part changing the region creation will \nrequire more work than the already sent.\n\nAbout this fix, it looks good to me, although I have to admit I'm a bit \nlost after following the discussion Allison points to. If we want to \nkeep the state of failure for forensics, not sure if the \ndebugging/tracing or default error info in this case will be enough.\n\nIn any case:\n\nReviewed-by: Alejandro Lucero <alucerop@amd.com>",
          "reply_to": "Gregory Price",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Gregory Price (author)",
          "summary": "Author acknowledged that keeping objects around causes more issues, expressed uncertainty about the frequency of the problem but did not commit to addressing it",
          "sentiment": "neutral",
          "sentiment_signals": [
            "uncertainty",
            "lack of commitment"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Yeah i don't quite follow the want to keep the objects around, it seems\nto cause more issues than it solves - but then i also don't think this\nis going to be a particularly common problem\n\n~Gregory",
          "reply_to": "Alejandro Palau",
          "message_date": "2026-02-24",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a region leak in the CXL driver when attaching a target fails. When `attach_target` returns an error, the auto-discovered region remains registered and consumes HPA resources without ever reaching a committed state. The patch tracks whether the region was created by checking the return value of `cxl_add_to_region`, and if it was not created successfully, it calls `drop_region` to unregister the region and release the HPA resource. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    },
    "2026-02-25": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a region leak in the CXL driver when attaching a target fails. When `attach_target` returns an error, the auto-discovered region remains registered and consumes HPA resources without ever reaching a committed state. The patch tracks whether the region was created by checking the return value of `cxl_add_to_region`, and if it was not created successfully, it calls `drop_region` to unregister the region and release the HPA resource. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    }
  }
}