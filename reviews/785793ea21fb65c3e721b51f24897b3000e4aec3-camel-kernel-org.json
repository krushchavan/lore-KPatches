{
  "thread_id": "785793ea21fb65c3e721b51f24897b3000e4aec3.camel@kernel.org",
  "subject": "Re: [LSF/MM/BPF TOPIC] Namespace-aware upcalls from kernel filesystems",
  "url": "https://lore.kernel.org/all/785793ea21fb65c3e721b51f24897b3000e4aec3.camel@kernel.org/",
  "dates": {
    "2026-02-17": {
      "report_file": "2026-02-17_ollama_llama3.1-8b.html",
      "developer": "Jeff Layton",
      "reviews": [
        {
          "author": "Chuck Lever",
          "summary": "Reviewer Chuck Lever suggested using existing namespace-aware netlink control interfaces, specifically mentioning their use in kernel TLS handshake and NFSD protocols.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "suggested alternative approach",
            "provided examples of existing implementations"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "\nOn Sat, Feb 14, 2026, at 5:06 AM, Shyam Prasad N wrote:\n> Kernel filesystems sometimes need to upcall to userspace to get some\n> work done, which cannot be achieved in kernel code (or rather it is\n> better to be done in userspace). Some examples are DNS resolutions,\n> user authentication, ID mapping etc.\n>\n> Filesystems like SMB and NFS clients use the kernel keys subsystem for\n> some of these, which has an upcall facility that can exec a binary in\n> userspace. However, this upcall mechanism is not namespace aware and\n> upcalls to the host namespaces (namespaces of the init process).\n\nHello Shyam, we've been introducing netlink control interfaces, which\nare namespace-aware. The kernel TLS handshake mechanism now uses\nthis approach, as does the new NFSD netlink protocol.\n\n\n-- \nChuck Lever\n\n\n---\n\n\n\nOn Mon, Feb 16, 2026, at 11:14 PM, Shyam Prasad N wrote:\n> On Sat, Feb 14, 2026 at 9:10 PM Chuck Lever <cel@kernel.org> wrote:\n>>\n>>\n>> On Sat, Feb 14, 2026, at 5:06 AM, Shyam Prasad N wrote:\n>> > Kernel filesystems sometimes need to upcall to userspace to get some\n>> > work done, which cannot be achieved in kernel code (or rather it is\n>> > better to be done in userspace). Some examples are DNS resolutions,\n>> > user authentication, ID mapping etc.\n>> >\n>> > Filesystems like SMB and NFS clients use the kernel keys subsystem for\n>> > some of these, which has an upcall facility that can exec a binary in\n>> > userspace. However, this upcall mechanism is not namespace aware and\n>> > upcalls to the host namespaces (namespaces of the init process).\n>>\n>> Hello Shyam, we've been introducing netlink control interfaces, which\n>> are namespace-aware. The kernel TLS handshake mechanism now uses\n>> this approach, as does the new NFSD netlink protocol.\n>>\n>>\n>> --\n>> Chuck Lever\n>\n> Hi Chuck,\n>\n> Interesting. Let me explore this a bit more.\n> I'm assuming that this is the file that I should be looking into:\n> fs/nfsd/nfsctl.c\n\nYes, clustered towards the end of the file. NFSD's use of netlink\nis as a downcall-style administrative control plane.\n\nnet/handshake/netlink.c uses netlink as an upcall for driving\nkernel-initiated TLS handshake requests up to a user daemon. This\nmechanism has been adopted by NFSD, the NFS client, and the NVMe\nover TCP drivers. An in-kernel QUIC implementation is planned and\nwill also be using this.\n\n\n> And that there would be a corresponding handler in nfs-utils?\n\nFor NFSD, nfs-utils has a new tool called nfsdctl.\n\nThe TLS handshake user space components are in ktls-utils. See:\nhttps://github.com/oracle/ktls-utils\n\n-- \nChuck Lever\n"
        },
        {
          "author": "David Leadbeater",
          "summary": "Reviewer David Leadbeater raised concerns about the safety of entering the right namespaces for upcalls from kernel filesystems, citing potential issues with seccomp and other container runtime limits.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes",
            "potential security issue"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "On Sat, Feb 14, 2026 at 03:36:22PM +0530, Shyam Prasad N wrote:\n> I tried to prototype a namespace aware upcall mechanism for kernel keys here:\n> https://www.spinics.net/lists/keyrings/msg17581.html\n> But it has not been successful so far. I'm seeking reviews on this\n> approach from security point of view.\n\nI have more context from the containers side, but to me this doesn't\nappear safe. Entering the right namespaces isn't enough to safely run\ncode within a container. The container runtime may have set up seccomp\nor other limits which this upcall won't respect.\n\nI would like to see a solution to this though, we currently have custom\ncallback code to make this work. I'm not familiar enough with the\ninterfaces but an approach where something registers also seems\ndesirable because it is able to preserve backwards compatibility, which\nchanging the namespace the upcall runs in doesn't.\n\nDavid\n"
        },
        {
          "author": "Shyam N (author)",
          "summary": "Reviewer Shyam N asked for more exploration of the issue, specifically looking into a file in fs/nfsd and considering seccomp visibility.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Acked-by"
          ],
          "analysis_source": "llm",
          "raw_body": "On Sat, Feb 14, 2026 at 9:10 PM Chuck Lever <cel@kernel.org> wrote:\n>\n>\n> On Sat, Feb 14, 2026, at 5:06 AM, Shyam Prasad N wrote:\n> > Kernel filesystems sometimes need to upcall to userspace to get some\n> > work done, which cannot be achieved in kernel code (or rather it is\n> > better to be done in userspace). Some examples are DNS resolutions,\n> > user authentication, ID mapping etc.\n> >\n> > Filesystems like SMB and NFS clients use the kernel keys subsystem for\n> > some of these, which has an upcall facility that can exec a binary in\n> > userspace. However, this upcall mechanism is not namespace aware and\n> > upcalls to the host namespaces (namespaces of the init process).\n>\n> Hello Shyam, we've been introducing netlink control interfaces, which\n> are namespace-aware. The kernel TLS handshake mechanism now uses\n> this approach, as does the new NFSD netlink protocol.\n>\n>\n> --\n> Chuck Lever\n\nHi Chuck,\n\nInteresting. Let me explore this a bit more.\nI'm assuming that this is the file that I should be looking into:\nfs/nfsd/nfsctl.c\nAnd that there would be a corresponding handler in nfs-utils?\n\n-- \nRegards,\nShyam\n\n\n---\n\nOn Mon, Feb 16, 2026 at 6:25 AM David Leadbeater <dgl@dgl.cx> wrote:\n>\n> On Sat, Feb 14, 2026 at 03:36:22PM +0530, Shyam Prasad N wrote:\n> > I tried to prototype a namespace aware upcall mechanism for kernel keys here:\n> > https://www.spinics.net/lists/keyrings/msg17581.html\n> > But it has not been successful so far. I'm seeking reviews on this\n> > approach from security point of view.\n>\n> I have more context from the containers side, but to me this doesn't\n> appear safe. Entering the right namespaces isn't enough to safely run\n> code within a container. The container runtime may have set up seccomp\n> or other limits which this upcall won't respect.\n\nHi David,\nThanks for these comments.\nLet me look into seccomp to see if kernel will have any visibility into it.\n\n>\n> I would like to see a solution to this though, we currently have custom\n> callback code to make this work. I'm not familiar enough with the\n> interfaces but an approach where something registers also seems\n> desirable because it is able to preserve backwards compatibility, which\n> changing the namespace the upcall runs in doesn't.\n\nAck. Will explore the options and get back to this thread.\n\n>\n> David\n>\n\n\n-- \nRegards,\nShyam\n"
        },
        {
          "author": "Jeff Layton",
          "summary": "The reviewer raised concerns about the original approach to namespace-aware upcalls and suggested moving away from usermodehelper as an upcall mechanism, citing a lack of container objects in the Linux kernel.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes",
            "suggested alternative"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "On Tue, 2026-02-17 at 09:21 -0500, Chuck Lever wrote:\n> \n> On Mon, Feb 16, 2026, at 11:14 PM, Shyam Prasad N wrote:\n> > On Sat, Feb 14, 2026 at 9:10 PM Chuck Lever <cel@kernel.org> wrote:\n> > > \n> > > \n> > > On Sat, Feb 14, 2026, at 5:06 AM, Shyam Prasad N wrote:\n> > > > Kernel filesystems sometimes need to upcall to userspace to get some\n> > > > work done, which cannot be achieved in kernel code (or rather it is\n> > > > better to be done in userspace). Some examples are DNS resolutions,\n> > > > user authentication, ID mapping etc.\n> > > > \n> > > > Filesystems like SMB and NFS clients use the kernel keys subsystem for\n> > > > some of these, which has an upcall facility that can exec a binary in\n> > > > userspace. However, this upcall mechanism is not namespace aware and\n> > > > upcalls to the host namespaces (namespaces of the init process).\n> > > \n> > > Hello Shyam, we've been introducing netlink control interfaces, which\n> > > are namespace-aware. The kernel TLS handshake mechanism now uses\n> > > this approach, as does the new NFSD netlink protocol.\n> > > \n> > > \n> > > --\n> > > Chuck Lever\n> > \n> > Hi Chuck,\n> > \n> > Interesting. Let me explore this a bit more.\n> > I'm assuming that this is the file that I should be looking into:\n> > fs/nfsd/nfsctl.c\n> \n> Yes, clustered towards the end of the file. NFSD's use of netlink\n> is as a downcall-style administrative control plane.\n> \n> net/handshake/netlink.c uses netlink as an upcall for driving\n> kernel-initiated TLS handshake requests up to a user daemon. This\n> mechanism has been adopted by NFSD, the NFS client, and the NVMe\n> over TCP drivers. An in-kernel QUIC implementation is planned and\n> will also be using this.\n> \n> \n> > And that there would be a corresponding handler in nfs-utils?\n> \n> For NFSD, nfs-utils has a new tool called nfsdctl.\n> \n> The TLS handshake user space components are in ktls-utils. See:\n> https://github.com/oracle/ktls-utils\n\n\nI think the consensus at this point is to move away from usermodehelper\nas an upcall mechanism. The Linux kernel lacks a container object that\nallows you to associate namespaces with one another, so you need an\nalready-running userspace process to do that association in userland.\n\nnetlink upcalls are bound to a network namespace. That works in the\nabove examples because they are also bound to a network namespace.\nnetlink upcalls require a running daemon in that namespace, which is\nwhat ties that network namespace to other sorts of namespaces.\n\nSo, a related discussion we should have is whether and how we should\ndeprecate the old usermodehelper upcalls, given that they are\nproblematic in this way. \n-- \nJeff Layton <jlayton@kernel.org>\n\n"
        }
      ],
      "analysis_source": "llm-per-reviewer"
    }
  }
}