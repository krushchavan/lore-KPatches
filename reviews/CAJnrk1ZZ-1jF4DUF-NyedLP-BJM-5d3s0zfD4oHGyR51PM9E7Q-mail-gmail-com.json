{
  "thread_id": "CAJnrk1ZZ=1jF4DUF-NyedLP-BJM_5d3s0zfD4oHGyR51PM9E7Q@mail.gmail.com",
  "subject": "[PATCH 1/5] fuse: flush pending FUSE_RELEASE requests before sending FUSE_DESTROY",
  "url": "https://lore.kernel.org/all/CAJnrk1ZZ=1jF4DUF-NyedLP-BJM_5d3s0zfD4oHGyR51PM9E7Q@mail.gmail.com/",
  "dates": {
    "2026-02-24": {
      "report_file": "2026-02-24.html",
      "developer": "Joanne Koong",
      "reviews": [
        {
          "author": "Darrick Wong",
          "summary": "I'm very confused by the comment style in this header file.  Some of them look like kerneldoc comments (albeit not documenting the sole parameter), but others are just regular C comments. <shrug> I sorta dislike kerneldoc's fussiness so I'll change it to a C comment so that I don't have to propagate this \"@param fc fuse connection\" verbosity. Yep, that was added for a previous iteration and can go away now. Right.  Fixed. How about I simplify it to: /* * Flush all pending requests before sending FUSE_DESTROY.  The * fuse server must reply to the flushed requests before * handling FUSE_DESTROY because unmount is about to release * its O_EXCL hold on the block device. */",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "nits"
          ],
          "has_inline_review": true,
          "tags_given": [],
          "analysis_source": "heuristic",
          "raw_body": "On Tue, Feb 24, 2026 at 11:33:12AM -0800, Joanne Koong wrote:\n> On Mon, Feb 23, 2026 at 3:06\\u202fPM Darrick J. Wong <djwong@kernel.org> wrote:\n> >\n> > From: Darrick J. Wong <djwong@kernel.org>\n> >\n> > generic/488 fails with fuse2fs in the following fashion:\n> >\n> > generic/488       _check_generic_filesystem: filesystem on /dev/sdf is inconsistent\n> > (see /var/tmp/fstests/generic/488.full for details)\n> >\n> > This test opens a large number of files, unlinks them (which really just\n> > renames them to fuse hidden files), closes the program, unmounts the\n> > filesystem, and runs fsck to check that there aren't any inconsistencies\n> > in the filesystem.\n> >\n> > Unfortunately, the 488.full file shows that there are a lot of hidden\n> > files left over in the filesystem, with incorrect link counts.  Tracing\n> > fuse_request_* shows that there are a large number of FUSE_RELEASE\n> > commands that are queued up on behalf of the unlinked files at the time\n> > that fuse_conn_destroy calls fuse_abort_conn.  Had the connection not\n> > aborted, the fuse server would have responded to the RELEASE commands by\n> > removing the hidden files; instead they stick around.\n> >\n> > For upper-level fuse servers that don't use fuseblk mode this isn't a\n> > problem because libfuse responds to the connection going down by pruning\n> > its inode cache and calling the fuse server's ->release for any open\n> > files before calling the server's ->destroy function.\n> >\n> > For fuseblk servers this is a problem, however, because the kernel sends\n> > FUSE_DESTROY to the fuse server, and the fuse server has to write all of\n> > its pending changes to the block device before replying to the DESTROY\n> > request because the kernel releases its O_EXCL hold on the block device.\n> > This means that the kernel must flush all pending FUSE_RELEASE requests\n> > before issuing FUSE_DESTROY.\n> >\n> > For fuse-iomap servers this will also be a problem because iomap servers\n> > are expected to release all exclusively-held resources before unmount\n> > returns from the kernel.\n> >\n> > Create a function to push all the background requests to the queue\n> > before sending FUSE_DESTROY.  That way, all the pending file release\n> > events are processed by the fuse server before it tears itself down, and\n> > we don't end up with a corrupt filesystem.\n> >\n> > Note that multithreaded fuse servers will need to track the number of\n> > open files and defer a FUSE_DESTROY request until that number reaches\n> > zero.  An earlier version of this patch made the kernel wait for the\n> > RELEASE acknowledgements before sending DESTROY, but the kernel people\n> > weren't comfortable with adding blocking waits to unmount.\n> >\n> > Signed-off-by: \"Darrick J. Wong\" <djwong@kernel.org>\n> \n> Overall LGTM, left a few comments below\n> \n> Reviewed-by: Joanne Koong <joannelkoong@gmail.com>\n\nThanks!\n\n> > ---\n> >  fs/fuse/fuse_i.h |    5 +++++\n> >  fs/fuse/dev.c    |   19 +++++++++++++++++++\n> >  fs/fuse/inode.c  |   12 +++++++++++-\n> >  3 files changed, 35 insertions(+), 1 deletion(-)\n> >\n> >\n> > diff --git a/fs/fuse/fuse_i.h b/fs/fuse/fuse_i.h\n> > index 7f16049387d15e..1d4beca5c7018d 100644\n> > --- a/fs/fuse/fuse_i.h\n> > +++ b/fs/fuse/fuse_i.h\n> > @@ -1287,6 +1287,11 @@ void fuse_request_end(struct fuse_req *req);\n> >  void fuse_abort_conn(struct fuse_conn *fc);\n> >  void fuse_wait_aborted(struct fuse_conn *fc);\n> >\n> > +/**\n> > + * Flush all pending requests but do not wait for them.\n> > + */\n> \n> nit: /*  */ comment style\n\nI'm very confused by the comment style in this header file.  Some of\nthem look like kerneldoc comments (albeit not documenting the sole\nparameter), but others are just regular C comments.\n\n<shrug> I sorta dislike kerneldoc's fussiness so I'll change it to a C\ncomment so that I don't have to propagate this \"@param fc fuse\nconnection\" verbosity.\n\n> > +void fuse_flush_requests(struct fuse_conn *fc);\n> > +\n> >  /* Check if any requests timed out */\n> >  void fuse_check_timeout(struct work_struct *work);\n> >\n> > diff --git a/fs/fuse/dev.c b/fs/fuse/dev.c\n> > index 0b0241f47170d4..ac9d7a7b3f5e68 100644\n> > --- a/fs/fuse/dev.c\n> > +++ b/fs/fuse/dev.c\n> > @@ -24,6 +24,7 @@\n> >  #include <linux/splice.h>\n> >  #include <linux/sched.h>\n> >  #include <linux/seq_file.h>\n> > +#include <linux/nmi.h>\n> \n> I don't think you meant to add this?\n\nYep, that was added for a previous iteration and can go away now.\n\n> >\n> >  #include \"fuse_trace.h\"\n> >\n> > @@ -2430,6 +2431,24 @@ static void end_polls(struct fuse_conn *fc)\n> >         }\n> >  }\n> >\n> > +/*\n> > + * Flush all pending requests and wait for them.  Only call this function when\n> \n> I think you meant \"don't wait\" for them?\n\nRight.  Fixed.\n\n> > + * it is no longer possible for other threads to add requests.\n> > + */\n> > +void fuse_flush_requests(struct fuse_conn *fc)\n> > +{\n> > +       spin_lock(&fc->lock);\n> > +       spin_lock(&fc->bg_lock);\n> > +       if (fc->connected) {\n> > +               /* Push all the background requests to the queue. */\n> > +               fc->blocked = 0;\n> > +               fc->max_background = UINT_MAX;\n> > +               flush_bg_queue(fc);\n> > +       }\n> > +       spin_unlock(&fc->bg_lock);\n> > +       spin_unlock(&fc->lock);\n> > +}\n> > +\n> >  /*\n> >   * Abort all requests.\n> >   *\n> > diff --git a/fs/fuse/inode.c b/fs/fuse/inode.c\n> > index e57b8af06be93e..58c3351b467221 100644\n> > --- a/fs/fuse/inode.c\n> > +++ b/fs/fuse/inode.c\n> > @@ -2086,8 +2086,18 @@ void fuse_conn_destroy(struct fuse_mount *fm)\n> >  {\n> >         struct fuse_conn *fc = fm->fc;\n> >\n> > -       if (fc->destroy)\n> > +       if (fc->destroy) {\n> > +               /*\n> > +                * Flush all pending requests (most of which will be\n> > +                * FUSE_RELEASE) before sending FUSE_DESTROY, because the fuse\n> > +                * server must close the filesystem before replying to the\n> > +                * destroy message, because unmount is about to release its\n> > +                * O_EXCL hold on the block device.  We don't wait, so libfuse\n> > +                * has to do that for us.\n> \n> nit: imo the \"because the fuse server must close the filesystem before\n> replying to the destroy message, because...\" part is confusing. Even\n> if that weren't true, the pending requests would still have to be sent\n> before the destroy, no? i think it would be less confusing if that\n> part of the paragraph was removed. I think it might be better to\n> remove the \"we don't wait, so libfuse has to do that for us\" part too\n> or rewording it to something like \"flushed requests are sent before\n> the FUSE_DESTROY. Userspace is responsible for ensuring flushed\n> requests are handled before replying to the FUSE_DESTROY\".\n\nHow about I simplify it to:\n\n\t/*\n\t * Flush all pending requests before sending FUSE_DESTROY.  The\n\t * fuse server must reply to the flushed requests before\n\t * handling FUSE_DESTROY because unmount is about to release\n\t * its O_EXCL hold on the block device.\n\t */\n\n--D\n\n> \n> Thanks,\n> Joanne\n> \n> > +                */\n> > +               fuse_flush_requests(fc);\n> >                 fuse_send_destroy(fm);\n> > +       }\n> >\n> >         fuse_abort_conn(fc);\n> >         fuse_wait_aborted(fc);\n> >\n> \n",
          "reply_to": "",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Joanne Koong (author)",
          "summary": "Oh I see your confusion now. Yeah the comment styles in this .h file are kind of all over the place. Most of the functions don't even have comments. This sounds a lot better to me.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "nits"
          ],
          "has_inline_review": true,
          "tags_given": [],
          "analysis_source": "heuristic",
          "raw_body": "On Tue, Feb 24, 2026 at 11:57 AM Darrick J. Wong <djwong@kernel.org> wrote:\n>\n> On Tue, Feb 24, 2026 at 11:33:12AM -0800, Joanne Koong wrote:\n> > On Mon, Feb 23, 2026 at 3:06 PM Darrick J. Wong <djwong@kernel.org> wrote:\n> > >\n> > > From: Darrick J. Wong <djwong@kernel.org>\n> > >\n> > > generic/488 fails with fuse2fs in the following fashion:\n> > >\n> > > generic/488       _check_generic_filesystem: filesystem on /dev/sdf is inconsistent\n> > > (see /var/tmp/fstests/generic/488.full for details)\n> > >\n> > > This test opens a large number of files, unlinks them (which really just\n> > > renames them to fuse hidden files), closes the program, unmounts the\n> > > filesystem, and runs fsck to check that there aren't any inconsistencies\n> > > in the filesystem.\n> > >\n> > > Unfortunately, the 488.full file shows that there are a lot of hidden\n> > > files left over in the filesystem, with incorrect link counts.  Tracing\n> > > fuse_request_* shows that there are a large number of FUSE_RELEASE\n> > > commands that are queued up on behalf of the unlinked files at the time\n> > > that fuse_conn_destroy calls fuse_abort_conn.  Had the connection not\n> > > aborted, the fuse server would have responded to the RELEASE commands by\n> > > removing the hidden files; instead they stick around.\n> > >\n> > > For upper-level fuse servers that don't use fuseblk mode this isn't a\n> > > problem because libfuse responds to the connection going down by pruning\n> > > its inode cache and calling the fuse server's ->release for any open\n> > > files before calling the server's ->destroy function.\n> > >\n> > > For fuseblk servers this is a problem, however, because the kernel sends\n> > > FUSE_DESTROY to the fuse server, and the fuse server has to write all of\n> > > its pending changes to the block device before replying to the DESTROY\n> > > request because the kernel releases its O_EXCL hold on the block device.\n> > > This means that the kernel must flush all pending FUSE_RELEASE requests\n> > > before issuing FUSE_DESTROY.\n> > >\n> > > For fuse-iomap servers this will also be a problem because iomap servers\n> > > are expected to release all exclusively-held resources before unmount\n> > > returns from the kernel.\n> > >\n> > > Create a function to push all the background requests to the queue\n> > > before sending FUSE_DESTROY.  That way, all the pending file release\n> > > events are processed by the fuse server before it tears itself down, and\n> > > we don't end up with a corrupt filesystem.\n> > >\n> > > Note that multithreaded fuse servers will need to track the number of\n> > > open files and defer a FUSE_DESTROY request until that number reaches\n> > > zero.  An earlier version of this patch made the kernel wait for the\n> > > RELEASE acknowledgements before sending DESTROY, but the kernel people\n> > > weren't comfortable with adding blocking waits to unmount.\n> > >\n> > > Signed-off-by: \"Darrick J. Wong\" <djwong@kernel.org>\n> >\n> > Overall LGTM, left a few comments below\n> >\n> > Reviewed-by: Joanne Koong <joannelkoong@gmail.com>\n>\n> Thanks!\n>\n> > > ---\n> > >  fs/fuse/fuse_i.h |    5 +++++\n> > >  fs/fuse/dev.c    |   19 +++++++++++++++++++\n> > >  fs/fuse/inode.c  |   12 +++++++++++-\n> > >  3 files changed, 35 insertions(+), 1 deletion(-)\n> > >\n> > >\n> > > diff --git a/fs/fuse/fuse_i.h b/fs/fuse/fuse_i.h\n> > > index 7f16049387d15e..1d4beca5c7018d 100644\n> > > --- a/fs/fuse/fuse_i.h\n> > > +++ b/fs/fuse/fuse_i.h\n> > > @@ -1287,6 +1287,11 @@ void fuse_request_end(struct fuse_req *req);\n> > >  void fuse_abort_conn(struct fuse_conn *fc);\n> > >  void fuse_wait_aborted(struct fuse_conn *fc);\n> > >\n> > > +/**\n> > > + * Flush all pending requests but do not wait for them.\n> > > + */\n> >\n> > nit: /*  */ comment style\n>\n> I'm very confused by the comment style in this header file.  Some of\n> them look like kerneldoc comments (albeit not documenting the sole\n> parameter), but others are just regular C comments.\n\nOh I see your confusion now. Yeah the comment styles in this .h file\nare kind of all over the place. Most of the functions don't even have\ncomments.\n\n>\n> <shrug> I sorta dislike kerneldoc's fussiness so I'll change it to a C\n> comment so that I don't have to propagate this \"@param fc fuse\n> connection\" verbosity.\n>\n> > > +void fuse_flush_requests(struct fuse_conn *fc);\n> > > +\n> > >  /* Check if any requests timed out */\n> > >  void fuse_check_timeout(struct work_struct *work);\n> > >\n> > > diff --git a/fs/fuse/dev.c b/fs/fuse/dev.c\n> > > index 0b0241f47170d4..ac9d7a7b3f5e68 100644\n> > > --- a/fs/fuse/dev.c\n> > > +++ b/fs/fuse/dev.c\n> > > @@ -24,6 +24,7 @@\n> > >  #include <linux/splice.h>\n> > >  #include <linux/sched.h>\n> > >  #include <linux/seq_file.h>\n> > > +#include <linux/nmi.h>\n> >\n> > I don't think you meant to add this?\n>\n> Yep, that was added for a previous iteration and can go away now.\n>\n> > >\n> > >  #include \"fuse_trace.h\"\n> > >\n> > > @@ -2430,6 +2431,24 @@ static void end_polls(struct fuse_conn *fc)\n> > >         }\n> > >  }\n> > >\n> > > +/*\n> > > + * Flush all pending requests and wait for them.  Only call this function when\n> >\n> > I think you meant \"don't wait\" for them?\n>\n> Right.  Fixed.\n>\n> > > + * it is no longer possible for other threads to add requests.\n> > > + */\n> > > +void fuse_flush_requests(struct fuse_conn *fc)\n> > > +{\n> > > +       spin_lock(&fc->lock);\n> > > +       spin_lock(&fc->bg_lock);\n> > > +       if (fc->connected) {\n> > > +               /* Push all the background requests to the queue. */\n> > > +               fc->blocked = 0;\n> > > +               fc->max_background = UINT_MAX;\n> > > +               flush_bg_queue(fc);\n> > > +       }\n> > > +       spin_unlock(&fc->bg_lock);\n> > > +       spin_unlock(&fc->lock);\n> > > +}\n> > > +\n> > >  /*\n> > >   * Abort all requests.\n> > >   *\n> > > diff --git a/fs/fuse/inode.c b/fs/fuse/inode.c\n> > > index e57b8af06be93e..58c3351b467221 100644\n> > > --- a/fs/fuse/inode.c\n> > > +++ b/fs/fuse/inode.c\n> > > @@ -2086,8 +2086,18 @@ void fuse_conn_destroy(struct fuse_mount *fm)\n> > >  {\n> > >         struct fuse_conn *fc = fm->fc;\n> > >\n> > > -       if (fc->destroy)\n> > > +       if (fc->destroy) {\n> > > +               /*\n> > > +                * Flush all pending requests (most of which will be\n> > > +                * FUSE_RELEASE) before sending FUSE_DESTROY, because the fuse\n> > > +                * server must close the filesystem before replying to the\n> > > +                * destroy message, because unmount is about to release its\n> > > +                * O_EXCL hold on the block device.  We don't wait, so libfuse\n> > > +                * has to do that for us.\n> >\n> > nit: imo the \"because the fuse server must close the filesystem before\n> > replying to the destroy message, because...\" part is confusing. Even\n> > if that weren't true, the pending requests would still have to be sent\n> > before the destroy, no? i think it would be less confusing if that\n> > part of the paragraph was removed. I think it might be better to\n> > remove the \"we don't wait, so libfuse has to do that for us\" part too\n> > or rewording it to something like \"flushed requests are sent before\n> > the FUSE_DESTROY. Userspace is responsible for ensuring flushed\n> > requests are handled before replying to the FUSE_DESTROY\".\n>\n> How about I simplify it to:\n>\n>         /*\n>          * Flush all pending requests before sending FUSE_DESTROY.  The\n>          * fuse server must reply to the flushed requests before\n>          * handling FUSE_DESTROY because unmount is about to release\n>          * its O_EXCL hold on the block device.\n>          */\n\nThis sounds a lot better to me.\n\nThanks,\nJoanne\n>\n> --D\n>\n> >\n> > Thanks,\n> > Joanne\n> >\n> > > +                */\n> > > +               fuse_flush_requests(fc);\n> > >                 fuse_send_destroy(fm);\n> > > +       }\n> > >\n> > >         fuse_abort_conn(fc);\n> > >         fuse_wait_aborted(fc);\n> > >\n> >\n",
          "reply_to": "",
          "message_date": "2026-02-24",
          "message_id": ""
        }
      ],
      "analysis_source": "heuristic"
    }
  }
}