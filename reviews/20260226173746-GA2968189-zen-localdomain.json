{
  "thread_id": "20260226173746.GA2968189@zen.localdomain",
  "subject": "[PATCH-RFC] btrfs: for unclustered allocation don't consider ffe_ctl->empty_cluster",
  "url": "https://lore.kernel.org/all/20260226173746.GA2968189@zen.localdomain/",
  "dates": {
    "2026-02-26": {
      "report_file": "2026-02-26_ollama_llama3.1-8b.html",
      "developer": "Boris Burkov",
      "reviews": [
        {
          "author": "Boris Burkov",
          "summary": "Acknowledged the potential bug and suggested revising the approach to clearly define relationships between variables.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "acknowledgment of potential bug",
            "request for revised patch"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "On Thu, Feb 26, 2026 at 09:37:46AM -0800, Boris Burkov wrote:\n> On Thu, Feb 26, 2026 at 01:34:19PM +0200, Alex Lyakas wrote:\n> > I encountered an issue when performing unclustered allocation for metadata:\n> > \n> > free_space_ctl->free_space = 2MB\n> > ffe_ctl->num_bytes = 4096\n> > ffe_ctl->empty_cluster = 2MB\n> > ffe_ctl->empty_size = 0\n> > \n> > So early check for free_space_ctl->free_space skips the block group, even though\n> > it has enough space to do the allocation.\n> > I think when doing unclustered allocation we should not look at ffe_ctl->empty_cluster.\n> \n> I see what you are saying, and a the level of this situation and this\n> line of code, I think you are right.\n> \n> But as-is, this change does not contain enough reasoning about the\n> semantics of the allocation algorithm to realistically be anything\n> but exchanging one bug for two new ones.\n> \n> What is empty_cluster modelling? Why is it included in this calculation?\n> Why should it not be included? Where else is empty_cluster used and\n> should it change under this new interpretation? Does any of this change\n> if there is actually a cluster active for clustered allocations?\n> \n> etc. etc.\n> \n> Thanks,\n> Boris\n> \n\nI missed the RFC tag in the patch, so I would like to apologize for my\nnegativity. In my experience with other bugs, the interplay between the\nclustered algorithm and the unclustered algorithm is under-specified so\nI think it is likely you have indeed found a bug. \n\nIf you want to fix it, I would proceed along the lines I complained\nabout in my first response and try to define the relationships between\nthe variables in a consistent way that explains why we shouldn't count\nthat variable here.\n\nIf you do go through with sharpening the definition of empty_cluster,\nI would be happy to review that work and help get it in.\n\nThanks,\nBoris\n\n> > \n> > I tested this on stable kernel 6.6.\n> > \n> > Signed-off-by: Alex Lyakas <alex.lyakas@zadara.com>\n> > ---\n> >  fs/btrfs/extent-tree.c | 2 +-\n> >  1 file changed, 1 insertion(+), 1 deletion(-)\n> > \n> > diff --git a/fs/btrfs/extent-tree.c b/fs/btrfs/extent-tree.c\n> > index 03cf9f242c70..84b340a67882 100644\n> > --- a/fs/btrfs/extent-tree.c\n> > +++ b/fs/btrfs/extent-tree.c\n> > @@ -3885,7 +3885,7 @@ static int find_free_extent_unclustered(struct btrfs_block_group *bg,\n> >  \t\tfree_space_ctl = bg->free_space_ctl;\n> >  \t\tspin_lock(&free_space_ctl->tree_lock);\n> >  \t\tif (free_space_ctl->free_space <\n> > -\t\t    ffe_ctl->num_bytes + ffe_ctl->empty_cluster +\n> > +\t\t    ffe_ctl->num_bytes +\n> >  \t\t    ffe_ctl->empty_size) {\n> >  \t\t\tffe_ctl->total_free_space = max_t(u64,\n> >  \t\t\t\t\tffe_ctl->total_free_space,\n> > -- \n> > 2.43.0\n> > \n\n",
          "reply_to": "",
          "message_date": "2026-02-26",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "Patch author's original patch aimed to modify btrfs allocation logic for unclustered scenarios, but a reviewer pointed out the missing RFC tag and suggested revising the approach."
    }
  }
}