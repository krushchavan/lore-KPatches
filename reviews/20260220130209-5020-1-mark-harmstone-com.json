{
  "thread_id": "20260220130209.5020-1-mark@harmstone.com",
  "subject": "[PATCH] btrfs: fix chunk map leak in btrfs_map_block() after btrfs_chunk_map_num_copies()",
  "url": "https://lore.kernel.org/all/20260220130209.5020-1-mark@harmstone.com/",
  "dates": {
    "2026-02-20": {
      "report_file": "2026-02-20.html",
      "developer": "Mark Harmstone",
      "reviews": [
        {
          "author": "Filipe Manana",
          "summary": "Side note: if there's a Fixes tag, we don't need a CC stable tag anymore nowadays.",
          "sentiment": "neutral",
          "sentiment_signals": [],
          "has_inline_review": true,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "heuristic",
          "raw_body": "On Fri, Feb 20, 2026 at 1:02â€¯PM Mark Harmstone <mark@harmstone.com> wrote:\n>\n> Fix a chunk map leak in btrfs_map_block(): if we return early with -EINVAL,\n> we're not freeing the chunk map that we've just looked up.\n>\n> Signed-off-by: Mark Harmstone <mark@harmstone.com>\n> Cc: stable@vger.kernel.org\n> Fixes: 0ae653fbec2b (\"btrfs: reduce chunk_map lookups in btrfs_map_block()\")\n\nReviewed-by: Filipe Manana <fdmanana@suse.com>\n\nSide note: if there's a Fixes tag, we don't need a CC stable tag\nanymore nowadays.\n\n\n\n> ---\n>  fs/btrfs/volumes.c | 6 ++++--\n>  1 file changed, 4 insertions(+), 2 deletions(-)\n>\n> diff --git a/fs/btrfs/volumes.c b/fs/btrfs/volumes.c\n> index 1bd3464ccdd8..a1f0fccd552c 100644\n> --- a/fs/btrfs/volumes.c\n> +++ b/fs/btrfs/volumes.c\n> @@ -7096,8 +7096,10 @@ int btrfs_map_block(struct btrfs_fs_info *fs_info, enum btrfs_map_op op,\n>         }\n>\n>         num_copies = btrfs_chunk_map_num_copies(map);\n> -       if (io_geom.mirror_num > num_copies)\n> -               return -EINVAL;\n> +       if (io_geom.mirror_num > num_copies) {\n> +               ret = -EINVAL;\n> +               goto out;\n> +       }\n>\n>         map_offset = logical - map->start;\n>         io_geom.raid56_full_stripe_start = (u64)-1;\n> --\n> 2.52.0\n>\n",
          "reply_to": "",
          "message_date": "2026-02-20",
          "message_id": ""
        },
        {
          "author": "Greg KH",
          "summary": "Not true at all, please read: https://www.kernel.org/doc/html/latest/process/stable-kernel-rules.html You HAVE to have a cc: stable if you know you want it to be added to a stable tree.",
          "sentiment": "neutral",
          "sentiment_signals": [],
          "has_inline_review": true,
          "tags_given": [],
          "analysis_source": "heuristic",
          "raw_body": "On Fri, Feb 20, 2026 at 01:07:27PM +0000, Filipe Manana wrote:\n> On Fri, Feb 20, 2026 at 1:02\\u202fPM Mark Harmstone <mark@harmstone.com> wrote:\n> >\n> > Fix a chunk map leak in btrfs_map_block(): if we return early with -EINVAL,\n> > we're not freeing the chunk map that we've just looked up.\n> >\n> > Signed-off-by: Mark Harmstone <mark@harmstone.com>\n> > Cc: stable@vger.kernel.org\n> > Fixes: 0ae653fbec2b (\"btrfs: reduce chunk_map lookups in btrfs_map_block()\")\n> \n> Reviewed-by: Filipe Manana <fdmanana@suse.com>\n> \n> Side note: if there's a Fixes tag, we don't need a CC stable tag\n> anymore nowadays.\n\nNot true at all, please read:\n\n    https://www.kernel.org/doc/html/latest/process/stable-kernel-rules.html\n\nYou HAVE to have a cc: stable if you know you want it to be added to a\nstable tree.  If you do not do that, you are at the mercy of \"when Greg\nand Sasha get bored and attempt to pick up things that maintainers\nforgot about\".\n\nthanks,\n\ngreg k-h\n\n",
          "reply_to": "",
          "message_date": "2026-02-20",
          "message_id": ""
        }
      ],
      "analysis_source": "heuristic",
      "patch_summary": "Fix a chunk map leak in btrfs_map_block(): if we return early with -EINVAL, we're not freeing the chunk map that we've just looked up."
    }
  }
}