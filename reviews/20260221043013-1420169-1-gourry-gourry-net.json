{
  "thread_id": "20260221043013.1420169-1-gourry@gourry.net",
  "subject": "[PATCH 1/2] cxl/region: fix region leak when attach_target fails in cxl_add_to_region",
  "url": "https://lore.kernel.org/all/20260221043013.1420169-1-gourry@gourry.net/",
  "dates": {
    "2026-02-20": {
      "report_file": "2026-02-21_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Gregory Price (author)",
          "summary": "Author addressed a concern about the default device_attach() call in cxl_add_to_region(), explained that it binds the dax driver and prevents regions from being converted to sysram, and agreed to skip this step when a custom attach callback is present.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "acknowledged fix needed"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "When a CXL memdev has a custom attach callback, cxl_add_to_region()\nshould not call device_attach() on the auto-discovered region.\n\nThe default device_attach() binds the dax driver, which may online\nmemory via dax_kmem.  The custom attach callback then has to tear down\nthe dax stack to convert the region to sysram, but dax_kmem refuses to\noffline memory during its remove path, leaving regions stuck online.\n\nSkip device_attach() when cxlmd->attach is set.  The attach callback\nis responsible for setting up the region after auto-discovery completes\n(e.g. adding it as sysram directly).\n\nSigned-off-by: Gregory Price <gourry@gourry.net>\n---\n drivers/cxl/core/region.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\ndiff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c\nindex 276046d49f88..e5edeabd9262 100644\n--- a/drivers/cxl/core/region.c\n+++ b/drivers/cxl/core/region.c\n@@ -3971,6 +3971,12 @@ int cxl_add_to_region(struct cxl_endpoint_decoder *cxled)\n \t}\n \n \tif (attach) {\n+\t\tstruct cxl_memdev *cxlmd = cxled_to_memdev(cxled);\n+\n+\t\t/* Skip device_attach if memdev has is own attach callback */\n+\t\tif (cxlmd->attach)\n+\t\t\treturn 0;\n+\n \t\t/*\n \t\t * If device_attach() fails the range may still be active via\n \t\t * the platform-firmware memory map, otherwise the driver for\n-- \n2.47.3",
          "reply_to": "",
          "message_date": "2026-02-20"
        }
      ],
      "analysis_source": "llm-per-reviewer",
      "patch_summary": "This patch fixes a region leak issue in the cxl driver by tracking whether a new region was created and calling drop_region() to unregister it and release its HPA resource if attach_target() fails. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    },
    "2026-02-21": {
      "report_file": "2026-02-21_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Gregory Price (author)",
          "summary": "Author is pushing back against the review, stating that the patch should be disregarded because it uses a function introduced by another contributor.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "pushing back",
            "disregard this patch"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "BAH - disregard this patch, it uses drop_region which is introduced by\nAlejandro here:\n\nhttps://lore.kernel.org/linux-cxl/20260201155438.2664640-20-alejandro.lucero-palau@amd.com/",
          "reply_to": "",
          "message_date": "2026-02-21"
        }
      ],
      "analysis_source": "llm-per-reviewer",
      "patch_summary": "This patch fixes a region leak issue in the cxl driver by tracking whether a new region was created and calling drop_region() to unregister it and release its HPA resource if attach_target() fails. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    },
    "2026-02-23": {
      "report_file": "2026-02-21_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Alison Schofield",
          "summary": "Reviewer noted that the patch drops the region only when newly created, but not for pre-existing regions, and suggested aligning this behavior with a previous patch that unregisters auto-created regions on assembly failure.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "I see you dropping this, perhaps just for the moment, because\nthe drop_region() you wanted to use is not available yet.\n\nThis looks a lot like \n\thttps://lore.kernel.org/linux-cxl/2a613604c0cdda6d9f838ae9b47ea6d936c5e4ce.1769746294.git.alison.schofield@intel.com/\n\tcxl/region: Unregister auto-created region when assembly fails\n\tWhen auto-created region assembly fails the region remains registered\n\tbut disabled. The region continues to reserve its memory resource,\n\tpreventing DAX from registering the memory.\n\tUnregister the region on assembly failure to release the resource.\n\nAnd the review comments on that one, or at least on that thread in\ngeneral, was to leave all the broken things in place.\nI didn't agree with that, and hope to see this version move ahead\nwhen you have the drop_region you need.\n\n-- Alison",
          "reply_to": "Gregory Price",
          "message_date": "2026-02-23"
        },
        {
          "author": "Gregory Price (author)",
          "summary": "Author acknowledged that the patch is more of a future-proofing measure, as no code currently utilizes the attach_target failure handling, and expressed it's not a particularly useful cleanup in the current infrastructure.\n\nThe author addressed Alison Schofield's concern that the patch does not handle auto-regions properly, explaining that in their driver, auto-regions are explicitly converted into other things and if this conversion fails, it causes all other region creation to fail. The author notes that this is a narrow failure scenario only occurring when two devices unbind/bind at the same time.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "acknowledged",
            "future-proofing",
            "clarification",
            "explanation"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Yeah it's not a particularly useful cleanup in the current\ninfrastructure because nothing actually uses this pattern (yet).\n\n---\n\nThe important note here is the difference between auto-regions and\nmanually created regions.  For auto-regions, you might have another\nendpoint show up looking for the partially created region - and then\njust go off and create it anyway because it thinks it was first.\n\nBut in my driver, i'm explicitly converting these auto-regions into\nother things, and if that fails it causes *all other* region creation to\nfail - even if it wasn't actually dependent on that original region.\n\nThis is only an issue if you have two devices unbind/bind cycling at\nthe same time - i.e.\n\n   echo 0000:d0:00.00 > cxl_pci/unbind\n   echo 0000:e0:00.00 > cxl_pci/unbind\n   echo 0000:d0:00.00 > mydriver/bind\n   echo 0000:e0:00.00 > mydriver/bind\n\nIf the platform has pre-programmed and locked the decoders, and one of\nthe two devices fails to probe and leaves a hanging partially\ncreated region, the other device will fail too.\n\nIt's a pretty narrow failure scenario.\n\n~Gregory",
          "reply_to": "Alison Schofield",
          "message_date": "2026-02-23"
        },
        {
          "author": "Alison Schofield",
          "summary": "Reviewer noted that the patch's handling of attach_target() failure is consistent with existing design, but pointed out a potential future issue where this same logic will fail again.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "acknowledgment",
            "future-problem"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "That's by design, and that'll eventually fail too.\n\nBut - is see how your case is different. Thanks for the explanation.",
          "reply_to": "Gregory Price",
          "message_date": "2026-02-23"
        }
      ],
      "analysis_source": "llm-per-reviewer",
      "patch_summary": "This patch fixes a region leak issue in the cxl driver by tracking whether a new region was created and calling drop_region() to unregister it and release its HPA resource if attach_target() fails. This prevents subsequent region creation attempts from failing due to reserved HPA ranges."
    }
  }
}