<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Review Comments: [PATCH v1 0/1] iomap: don&#x27;t mark folio uptodate if read IO has bytes pending</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .home-link { margin-bottom: 12px; display: block; }
        .home-link a { color: #0366d6; text-decoration: none; font-size: 0.9em; }
        .home-link a:hover { text-decoration: underline; }

        h1 { font-size: 1.3em; margin-bottom: 2px; color: #1a1a1a; line-height: 1.3; }

        .lore-link { font-size: 0.85em; margin: 4px 0 6px; display: block; }
        .lore-link a { color: #0366d6; text-decoration: none; }
        .lore-link a:hover { text-decoration: underline; }

        .date-range {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 16px;
        }
        .date-range a { color: #0366d6; text-decoration: none; }
        .date-range a:hover { text-decoration: underline; }

        /* thread-node scroll margin so the card isn't clipped at the top */
        .thread-node { scroll-margin-top: 8px; }

        /* ── Patch summary ──────────────────────────────────────────── */
        .patch-summary-block {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 3px solid #4a90d9;
        }
        .patch-summary-label {
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #4a90d9;
            margin-bottom: 4px;
        }
        .patch-summary-text {
            font-size: 0.88em;
            color: #444;
            line-height: 1.55;
        }

        /* ── Thread tree ────────────────────────────────────────────── */
        .thread-tree {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Depth indentation via left border */
        .thread-node { position: relative; }
        .thread-children {
            margin-left: 20px;
            padding-left: 12px;
            border-left: 2px solid #e0e0e0;
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ── Review comment card ────────────────────────────────────── */
        .review-comment {
            background: #fff;
            border-radius: 6px;
            padding: 10px 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            font-size: 0.88em;
        }
        .review-comment-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 5px;
        }
        .review-author {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 0.95em;
        }

        /* Date chip — links back to the daily report */
        .date-chip {
            font-size: 0.75em;
            color: #777;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 1px 7px;
            text-decoration: none;
            white-space: nowrap;
        }
        a.date-chip:hover { background: #e0e8f5; color: #0366d6; }

        .badge {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .inline-review-badge {
            display: inline-block;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 500;
            background: #e3f2fd;
            color: #1565c0;
        }
        .review-tag-badge {
            display: inline-block;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 500;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .analysis-source-badge {
            display: inline-block;
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 0.72em;
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .review-comment-text {
            color: #444;
            line-height: 1.55;
            margin-bottom: 4px;
        }
        .review-comment-signals {
            margin-top: 3px;
            font-size: 0.85em;
            color: #aaa;
            font-style: italic;
        }

        /* ── Collapsible raw body ───────────────────────────────────── */
        .raw-body-toggle {
            margin-top: 5px;
            font-size: 0.85em;
        }
        .raw-body-toggle summary {
            cursor: pointer;
            color: #888;
            padding: 2px 0;
            font-weight: 500;
            font-size: 0.9em;
            list-style: none;
        }
        .raw-body-toggle summary::-webkit-details-marker { display: none; }
        .raw-body-toggle summary::before { content: "▶ "; font-size: 0.7em; }
        .raw-body-toggle[open] summary::before { content: "▼ "; }
        .raw-body-toggle summary:hover { color: #555; }
        .raw-body-text {
            white-space: pre-wrap;
            font-size: 0.95em;
            background: #f8f8f8;
            padding: 8px 10px;
            border-radius: 4px;
            max-height: 360px;
            overflow-y: auto;
            margin-top: 4px;
            line-height: 1.5;
            color: #444;
            border: 1px solid #e8e8e8;
        }

        .no-reviews {
            color: #aaa;
            font-size: 0.85em;
            font-style: italic;
            padding: 8px 0;
        }

        footer {
            text-align: center;
            color: #bbb;
            font-size: 0.78em;
            margin-top: 36px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="home-link"><a href="../">&larr; Back to reports</a></div>
    <h1>[PATCH v1 0/1] iomap: don&#x27;t mark folio uptodate if read IO has bytes pending</h1>
    <div class="lore-link"><a href="https://lore.kernel.org/all/20260219003911.344478-1-joannelkoong@gmail.com/" target="_blank">View on lore.kernel.org &rarr;</a></div>
    <div class="date-range">Active on: <a href="#2026-02-19">2026-02-19</a></div>
    <div class="patch-summary-block"><div class="patch-summary-label">Patch summary</div><div class="patch-summary-text">This patch prevents marking a folio as uptodate if there are still bytes pending from a read IO operation, which can lead to incorrect behavior when the remaining bytes are processed.</div></div>
    <div class="thread-tree">
<div class="thread-node depth-0" id="2026-02-19">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Joanne Koong (author)</span>
<a class="date-chip" href="../2026-02-19_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-19">2026-02-19</a>
<span class="inline-review-badge">Inline Review</span>
<span class="review-tag-badge">Reviewed-by</span>
<span class="badge" style="color:#856404;background:#fff3cd">Needs Work</span>
<span class="analysis-source-badge" style="color:#004085;background:#cce5ff" title="Analysis source: LLM">LLM</span>
</div>
<div class="review-comment-text">Joanne Koong raised a technical concern that the patch may cause issues when a folio is partially read through an async IO helper and then post-EOF zeroing or inline data, leading to incorrect uptodate state.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">If a folio has ifs metadata attached to it and the folio is partially
read in through an async IO helper with the rest of it then being read
in through post-EOF zeroing or as inline data, and the helper
successfully finishes the read first, then post-EOF zeroing / reading
inline will mark the folio as uptodate in iomap_set_range_uptodate().

This is a problem because when the read completion path later calls
iomap_read_end(), it will call folio_end_read(), which sets the uptodate
bit using XOR semantics. Calling folio_end_read() on a folio that was
already marked uptodate clears the uptodate bit.

Fix this by not marking the folio as uptodate if the read IO has bytes
pending. The folio uptodate state will be set in the read completion
path through iomap_end_read() -&gt; folio_end_read().

Reported-by: Wei Gao &lt;wegao@suse.com&gt;
Suggested-by: Sasha Levin &lt;sashal@kernel.org&gt;
Tested-by: Wei Gao &lt;wegao@suse.com&gt;
Signed-off-by: Joanne Koong &lt;joannelkoong@gmail.com&gt;
Fixes: b2f35ac4146d (&quot;iomap: add caller-provided callbacks for read and readahead&quot;)
---
 fs/iomap/buffered-io.c | 15 ++++++++++++---
 1 file changed, 12 insertions(+), 3 deletions(-)

diff --git a/fs/iomap/buffered-io.c b/fs/iomap/buffered-io.c
index 58887513b894..4fc5ce963feb 100644
--- a/fs/iomap/buffered-io.c
+++ b/fs/iomap/buffered-io.c
@@ -80,18 +80,27 @@ static void iomap_set_range_uptodate(struct folio *folio, size_t off,
 {
 	struct iomap_folio_state *ifs = folio-&gt;private;
 	unsigned long flags;
-	bool uptodate = true;
+	bool mark_uptodate = true;
 
 	if (folio_test_uptodate(folio))
 		return;
 
 	if (ifs) {
 		spin_lock_irqsave(&amp;ifs-&gt;state_lock, flags);
-		uptodate = ifs_set_range_uptodate(folio, ifs, off, len);
+		/*
+		 * If a read with bytes pending is in progress, we must not call
+		 * folio_mark_uptodate(). The read completion path
+		 * (iomap_read_end()) will call folio_end_read(), which uses XOR
+		 * semantics to set the uptodate bit. If we set it here, the XOR
+		 * in folio_end_read() will clear it, leaving the folio not
+		 * uptodate.
+		 */
+		mark_uptodate = ifs_set_range_uptodate(folio, ifs, off, len) &amp;&amp;
+				!ifs-&gt;read_bytes_pending;
 		spin_unlock_irqrestore(&amp;ifs-&gt;state_lock, flags);
 	}
 
-	if (uptodate)
+	if (mark_uptodate)
 		folio_mark_uptodate(folio);
 }
 
-- 
2.47.3

</pre>
</details>
<div class="review-comment-signals">Signals: technical concern, potential bug</div>
</div>
</div>
<div class="thread-node depth-0">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Darrick Wong</span>
<a class="date-chip" href="../2026-02-19_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-19">2026-02-19</a>
<span class="review-tag-badge">Reviewed-by</span>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#004085;background:#cce5ff" title="Analysis source: LLM">LLM</span>
</div>
<div class="review-comment-text">Reviewer Darrick Wong raised no technical concerns, but instead asked about the difficulty of writing an fstest for this patch and provided a Reviewed-by tag.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On Wed, Feb 18, 2026 at 04:39:11PM -0800, Joanne Koong wrote:
&gt; If a folio has ifs metadata attached to it and the folio is partially
&gt; read in through an async IO helper with the rest of it then being read
&gt; in through post-EOF zeroing or as inline data, and the helper
&gt; successfully finishes the read first, then post-EOF zeroing / reading
&gt; inline will mark the folio as uptodate in iomap_set_range_uptodate().
&gt; 
&gt; This is a problem because when the read completion path later calls
&gt; iomap_read_end(), it will call folio_end_read(), which sets the uptodate
&gt; bit using XOR semantics. Calling folio_end_read() on a folio that was
&gt; already marked uptodate clears the uptodate bit.

Aha, I wondered if that xor thing was going to come back to bite us.

&gt; Fix this by not marking the folio as uptodate if the read IO has bytes
&gt; pending. The folio uptodate state will be set in the read completion
&gt; path through iomap_end_read() -&gt; folio_end_read().
&gt; 
&gt; Reported-by: Wei Gao &lt;wegao@suse.com&gt;
&gt; Suggested-by: Sasha Levin &lt;sashal@kernel.org&gt;
&gt; Tested-by: Wei Gao &lt;wegao@suse.com&gt;
&gt; Signed-off-by: Joanne Koong &lt;joannelkoong@gmail.com&gt;
&gt; Fixes: b2f35ac4146d (&quot;iomap: add caller-provided callbacks for read and readahead&quot;)

I would add:

Link: https://lore.kernel.org/linux-fsdevel/aYbmy8JdgXwsGaPP@autotest-wegao.qe.prg2.suse.org/
Cc: &lt;stable@vger.kernel.org&gt; # v6.19

since the recent discussion around this was sort of buried in a
different thread, and the original patch is now in a released kernel.

&gt; ---
&gt;  fs/iomap/buffered-io.c | 15 ++++++++++++---
&gt;  1 file changed, 12 insertions(+), 3 deletions(-)
&gt; 
&gt; diff --git a/fs/iomap/buffered-io.c b/fs/iomap/buffered-io.c
&gt; index 58887513b894..4fc5ce963feb 100644
&gt; --- a/fs/iomap/buffered-io.c
&gt; +++ b/fs/iomap/buffered-io.c
&gt; @@ -80,18 +80,27 @@ static void iomap_set_range_uptodate(struct folio *folio, size_t off,
&gt;  {
&gt;  	struct iomap_folio_state *ifs = folio-&gt;private;
&gt;  	unsigned long flags;
&gt; -	bool uptodate = true;
&gt; +	bool mark_uptodate = true;
&gt;  
&gt;  	if (folio_test_uptodate(folio))
&gt;  		return;
&gt;  
&gt;  	if (ifs) {
&gt;  		spin_lock_irqsave(&amp;ifs-&gt;state_lock, flags);
&gt; -		uptodate = ifs_set_range_uptodate(folio, ifs, off, len);
&gt; +		/*
&gt; +		 * If a read with bytes pending is in progress, we must not call
&gt; +		 * folio_mark_uptodate(). The read completion path
&gt; +		 * (iomap_read_end()) will call folio_end_read(), which uses XOR
&gt; +		 * semantics to set the uptodate bit. If we set it here, the XOR
&gt; +		 * in folio_end_read() will clear it, leaving the folio not
&gt; +		 * uptodate.

Yeah, that makes sense.  How difficult is this to write up as an fstest?

Reviewed-by: &quot;Darrick J. Wong&quot; &lt;djwong@kernel.org&gt;

--D

&gt; +		 */
&gt; +		mark_uptodate = ifs_set_range_uptodate(folio, ifs, off, len) &amp;&amp;
&gt; +				!ifs-&gt;read_bytes_pending;
&gt;  		spin_unlock_irqrestore(&amp;ifs-&gt;state_lock, flags);
&gt;  	}
&gt;  
&gt; -	if (uptodate)
&gt; +	if (mark_uptodate)
&gt;  		folio_mark_uptodate(folio);
&gt;  }
&gt;  
&gt; -- 
&gt; 2.47.3
&gt; 
&gt; 


---

On Thu, Feb 19, 2026 at 04:23:23AM +0000, Matthew Wilcox wrote:
&gt; On Wed, Feb 18, 2026 at 06:45:34PM -0800, Darrick J. Wong wrote:
&gt; &gt; On Wed, Feb 18, 2026 at 04:39:11PM -0800, Joanne Koong wrote:
&gt; &gt; &gt; If a folio has ifs metadata attached to it and the folio is partially
&gt; &gt; &gt; read in through an async IO helper with the rest of it then being read
&gt; &gt; &gt; in through post-EOF zeroing or as inline data, and the helper
&gt; &gt; &gt; successfully finishes the read first, then post-EOF zeroing / reading
&gt; &gt; &gt; inline will mark the folio as uptodate in iomap_set_range_uptodate().
&gt; &gt; &gt; 
&gt; &gt; &gt; This is a problem because when the read completion path later calls
&gt; &gt; &gt; iomap_read_end(), it will call folio_end_read(), which sets the uptodate
&gt; &gt; &gt; bit using XOR semantics. Calling folio_end_read() on a folio that was
&gt; &gt; &gt; already marked uptodate clears the uptodate bit.
&gt; &gt; 
&gt; &gt; Aha, I wondered if that xor thing was going to come back to bite us.
&gt; 
&gt; This isn&#x27;t &quot;the xor thing has come back to bite us&quot;.  This is &quot;the iomap
&gt; code is now too complicated and I cannot figure out how to explain to
&gt; Joanne that there&#x27;s really a simple way to do this&quot;.
&gt; 
&gt; I&#x27;m going to have to set aside my current projects and redo the iomap
&gt; readahead/read_folio code myself, aren&#x27;t I?

Well you could try explaining to me what that simpler way is?

/me gets the sense he&#x27;s missing a discussion somewhere...

--D
</pre>
</details>
<div class="review-comment-signals">Signals: no technical concerns raised</div>
</div>
</div>
<div class="thread-node depth-0">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Matthew Wilcox</span>
<a class="date-chip" href="../2026-02-19_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-19">2026-02-19</a>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#004085;background:#cce5ff" title="Analysis source: LLM">LLM</span>
</div>
<div class="review-comment-text">Matthew Wilcox expressed frustration with the complexity of the iomap code and implied that he needs to rework it himself.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On Wed, Feb 18, 2026 at 06:45:34PM -0800, Darrick J. Wong wrote:
&gt; On Wed, Feb 18, 2026 at 04:39:11PM -0800, Joanne Koong wrote:
&gt; &gt; If a folio has ifs metadata attached to it and the folio is partially
&gt; &gt; read in through an async IO helper with the rest of it then being read
&gt; &gt; in through post-EOF zeroing or as inline data, and the helper
&gt; &gt; successfully finishes the read first, then post-EOF zeroing / reading
&gt; &gt; inline will mark the folio as uptodate in iomap_set_range_uptodate().
&gt; &gt; 
&gt; &gt; This is a problem because when the read completion path later calls
&gt; &gt; iomap_read_end(), it will call folio_end_read(), which sets the uptodate
&gt; &gt; bit using XOR semantics. Calling folio_end_read() on a folio that was
&gt; &gt; already marked uptodate clears the uptodate bit.
&gt; 
&gt; Aha, I wondered if that xor thing was going to come back to bite us.

This isn&#x27;t &quot;the xor thing has come back to bite us&quot;.  This is &quot;the iomap
code is now too complicated and I cannot figure out how to explain to
Joanne that there&#x27;s really a simple way to do this&quot;.

I&#x27;m going to have to set aside my current projects and redo the iomap
readahead/read_folio code myself, aren&#x27;t I?
</pre>
</details>
<div class="review-comment-signals">Signals: frustration, implied need for rework</div>
</div>
</div>
<div class="thread-node depth-0">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Christoph Hellwig</span>
<a class="date-chip" href="../2026-02-19_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-19">2026-02-19</a>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#004085;background:#cce5ff" title="Analysis source: LLM">LLM</span>
</div>
<div class="review-comment-text">Christoph Hellwig raised no specific technical concerns or objections to the patch, but instead simply repeated &#x27;same&#x27; without any context.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On Wed, Feb 18, 2026 at 10:11:01PM -0800, Darrick J. Wong wrote:
&gt; &gt; This isn&#x27;t &quot;the xor thing has come back to bite us&quot;.  This is &quot;the iomap
&gt; &gt; code is now too complicated and I cannot figure out how to explain to
&gt; &gt; Joanne that there&#x27;s really a simple way to do this&quot;.
&gt; &gt; 
&gt; &gt; I&#x27;m going to have to set aside my current projects and redo the iomap
&gt; &gt; readahead/read_folio code myself, aren&#x27;t I?
&gt; 
&gt; Well you could try explaining to me what that simpler way is?
&gt; 
&gt; /me gets the sense he&#x27;s missing a discussion somewhere...

Same.


</pre>
</details>
<div class="review-comment-signals">Signals: lack of clear signal, no technical discussion</div>
</div>
</div>
</div>

    <footer>LKML Daily Activity Tracker</footer>
    <script>
    // When arriving via a date anchor (e.g. #2026-02-15 from a daily report),
    // scroll the anchor into view after a brief delay so layout is complete.
    (function () {
        var hash = window.location.hash;
        if (!hash) return;
        var target = document.getElementById(hash.slice(1));
        if (!target) return;
        setTimeout(function () {
            target.scrollIntoView({behavior: 'smooth', block: 'start'});
        }, 80);
    })();
    </script>
</body>
</html>