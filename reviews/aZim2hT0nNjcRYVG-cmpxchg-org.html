<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Review Comments: [LSF/MM/BPF TOPIC] Improving MGLRU</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .home-link { margin-bottom: 12px; display: block; }
        .home-link a { color: #0366d6; text-decoration: none; font-size: 0.9em; }
        .home-link a:hover { text-decoration: underline; }

        h1 { font-size: 1.3em; margin-bottom: 2px; color: #1a1a1a; line-height: 1.3; }

        .lore-link { font-size: 0.85em; margin: 4px 0 6px; display: block; }
        .lore-link a { color: #0366d6; text-decoration: none; }
        .lore-link a:hover { text-decoration: underline; }

        .date-range {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 16px;
        }
        .date-range a { color: #0366d6; text-decoration: none; }
        .date-range a:hover { text-decoration: underline; }

        /* thread-node scroll margin so the card isn't clipped at the top */
        .thread-node { scroll-margin-top: 8px; }

        /* ── Patch summary ──────────────────────────────────────────── */
        .patch-summary-block {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 3px solid #4a90d9;
        }
        .patch-summary-label {
            font-size: 0.72em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #4a90d9;
            margin-bottom: 4px;
        }
        .patch-summary-text {
            font-size: 0.88em;
            color: #444;
            line-height: 1.55;
        }

        /* ── Thread tree ────────────────────────────────────────────── */
        .thread-tree {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Depth indentation via left border */
        .thread-node { position: relative; }
        .thread-children {
            margin-left: 20px;
            padding-left: 12px;
            border-left: 2px solid #e0e0e0;
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* ── Review comment card ────────────────────────────────────── */
        .review-comment {
            background: #fff;
            border-radius: 6px;
            padding: 10px 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            font-size: 0.88em;
        }
        .review-comment-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 5px;
        }
        .review-author {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 0.95em;
        }

        /* Date chip — links back to the daily report */
        .date-chip {
            font-size: 0.75em;
            color: #777;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 1px 7px;
            text-decoration: none;
            white-space: nowrap;
        }
        a.date-chip:hover { background: #e0e8f5; color: #0366d6; }

        .badge {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .inline-review-badge {
            display: inline-block;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 500;
            background: #e3f2fd;
            color: #1565c0;
        }
        .review-tag-badge {
            display: inline-block;
            padding: 0 6px;
            border-radius: 8px;
            font-size: 0.78em;
            font-weight: 500;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .analysis-source-badge {
            display: inline-block;
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 0.72em;
            font-weight: 600;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .review-comment-text {
            color: #444;
            line-height: 1.55;
            margin-bottom: 4px;
        }
        .review-comment-signals {
            margin-top: 3px;
            font-size: 0.85em;
            color: #aaa;
            font-style: italic;
        }

        /* ── Collapsible raw body ───────────────────────────────────── */
        .raw-body-toggle {
            margin-top: 5px;
            font-size: 0.85em;
        }
        .raw-body-toggle summary {
            cursor: pointer;
            color: #888;
            padding: 2px 0;
            font-weight: 500;
            font-size: 0.9em;
            list-style: none;
        }
        .raw-body-toggle summary::-webkit-details-marker { display: none; }
        .raw-body-toggle summary::before { content: "▶ "; font-size: 0.7em; }
        .raw-body-toggle[open] summary::before { content: "▼ "; }
        .raw-body-toggle summary:hover { color: #555; }
        .raw-body-text {
            white-space: pre-wrap;
            font-size: 0.95em;
            background: #f8f8f8;
            padding: 8px 10px;
            border-radius: 4px;
            max-height: 360px;
            overflow-y: auto;
            margin-top: 4px;
            line-height: 1.5;
            color: #444;
            border: 1px solid #e8e8e8;
        }
        .reply-to-label {
            font-size: 0.8em;
            color: #999;
            font-style: italic;
            margin-top: 3px;
        }
        .lore-link {
            display: inline-block;
            margin-top: 4px;
            font-size: 0.82em;
            color: #0366d6;
            text-decoration: none;
            font-weight: 500;
            white-space: nowrap;
        }
        .lore-link:hover { text-decoration: underline; color: #0056b3; }

        .no-reviews {
            color: #aaa;
            font-size: 0.85em;
            font-style: italic;
            padding: 8px 0;
        }

        footer {
            text-align: center;
            color: #bbb;
            font-size: 0.78em;
            margin-top: 36px;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div class="home-link"><a href="../index.html">&larr; Back to reports</a></div>
    <h1>[LSF/MM/BPF TOPIC] Improving MGLRU</h1>
    <div class="lore-link"><a href="https://lore.kernel.org/all/aZim2hT0nNjcRYVG@cmpxchg.org/" target="_blank">View on lore.kernel.org &rarr;</a></div>
    <div class="date-range">Active on: <a href="#2026-02-21">2026-02-21</a> &bull; <a href="#2026-02-20">2026-02-20</a></div>
    
    <div class="thread-tree">
<div class="thread-node depth-0" id="2026-02-21">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Kairui Song</span>
<a class="date-chip" href="../2026-02-20_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-21">2026-02-21</a>
<span class="inline-review-badge">Inline Review</span>
<span class="badge" style="color:#383d41;background:#e2e3e5">Neutral</span>
<span class="analysis-source-badge" style="color:#6c4b00;background:#ffeeba" title="Analysis source: Heuristic">Heuristic</span>
</div>
<div class="review-comment-text">A bit more than that. When there is no swap, MGLRU still performs worse in some workloads like MongoDB. From what I&#x27;ve noticed that&#x27;s because the PID protection is a bit too passive, and there is a force protection in sort_folio which sometimes seems too aggressive. Active/Inactive LRU will just move a folio to head if it&#x27;s accessed twice while in RAM, but MGLRU won&#x27;t do so, as result hotter file folios are evicted equally as the colder one until the PID gets triggered, or still gets protected even if it hasn&#x27;t been used for a while. And by the time PID finally gets triggered, the workload might has changed.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On Sat, Feb 21, 2026 at 2:24 AM Johannes Weiner &lt;hannes@cmpxchg.org&gt; wrote:
&gt;
&gt; On Fri, Feb 20, 2026 at 01:25:33AM +0800, Kairui Song wrote:
&gt; &gt; Hi All,
&gt; &gt;
&gt; &gt; Apologies I forgot to add the proper tag in the previous email so
&gt; &gt; resending this.
&gt; &gt;
&gt; &gt; MGLRU has been introduced in the mainline for years, but we still have two LRUs
&gt; &gt; today. There are many reasons MGLRU is still not the only LRU implementation in
&gt; &gt; the kernel.
&gt; &gt;
&gt; &gt; And I&#x27;ve been looking at a few major issues here:
&gt; &gt;
&gt; &gt; 1. Page flag usage: MGLRU uses many more flags (3+ more) than Active/Inactive
&gt; &gt; LRU.
&gt; &gt; 2. Regressions: MGLRU might cause regression, even though in many workloads it
&gt; &gt; outperforms Active/Inactive by a lot.
&gt; &gt; 3. Metrics: MGLRU makes some metrics work differently, for example: PSI,
&gt; &gt; /proc/meminfo.
&gt; &gt; 4. Some reclaim behavior is less controllable.
&gt;
&gt; I would be very interested in discussing this topic as well.

Thanks, glad to hear that!

&gt;
&gt; &gt; 2. Regressions: Currently regression is a more major problem for us.
&gt; &gt;    From our perspective, almost all regressions are caused by an under- or
&gt; &gt;    overprotected file cache. MGLRU&#x27;s PID protection either gets too aggressive
&gt; &gt;    or too passive or just have a too long latency. To fix that, I&#x27;d propose a
&gt; &gt;    LFU-like design and relax the PID&#x27;s aggressiveness to make it much more
&gt; &gt;    proactive and effective for file folios. The idea is always use 3 bits in
&gt; &gt;    the page flags to count the referenced time (which would also replace
&gt; &gt;    PG_workingset and PG_referenced). Initial tests showed a 30% reduction of
&gt; &gt;    refaults, and many regressions are gone. A flow chart of how the MGLRU idea
&gt; &gt;    might work:
&gt;
&gt; Are you referring to refaults on the page cache side, or swapins?
&gt;
&gt; Last time we evaluated MGLRU on Meta workloads, we noticed that it
&gt; tends to do better with zswap, but worse with disk swap. It seemed to
&gt; just prefer reclaiming anon, period.
&gt;
&gt; For the balancing between anon and file to work well in all
&gt; situations, it needs to have a notion of backend speed and factor in
&gt; the respective cost of misses on each side.

A bit more than that. When there is no swap, MGLRU still performs
worse in some workloads like MongoDB. From what I&#x27;ve noticed that&#x27;s
because the PID protection is a bit too passive, and there is a force
protection in sort_folio which sometimes seems too aggressive.
Active/Inactive LRU will just move a folio to head if it&#x27;s accessed
twice while in RAM, but MGLRU won&#x27;t do so, as result hotter file
folios are evicted equally as the colder one until the PID gets
triggered, or still gets protected even if it hasn&#x27;t been used for a
while. And by the time PID finally gets triggered, the workload might
has changed. This is fixable using the approach I mentioned though,
and it seems to be better than the Active/Inactive in all our known
cases after that, whether that is a good fix worth discussion.

I also notice Ridong has a series to apply a &quot;heat&quot; based reclaim,
which also looks interesting.

&gt; &gt;    Can we just ignore the shadow for anon folios? MGLRU basically activates
&gt; &gt;    anon folios unconditionally, especially if we combined with the LFU like
&gt; &gt;    idea above we might only want to track the 3 bit count, and get rid of
&gt; &gt;    the extra bit usage in the shadow. The eviction performance might be even
&gt; &gt;    better, and other components like swap table [3] will have more bits to use
&gt; &gt;    for better performance and more features.
&gt;
&gt; On the face of it, both of these sounds problematic to me. Why are
&gt; anon pages special cased?
&gt;
&gt; The cost of reclaiming a page is:
&gt;
&gt;     reuse frequency * cost of a miss
&gt;
&gt; The *type* of the page is not all that meaningful for workload
&gt; performance. The wait time is qualitatively the same.
&gt;
&gt; If you assume every refaulting anon is hot, it&#x27;ll fall apart when the
&gt; anon set is huge and has little locality.

Sorry I didn&#x27;t make it clear. For MGLRU currently it already ignored
the shadow distance for re-activation. And yeah, basically all anons
are activated on fault, which turns out to be quite nice? None MGLRU
users considered that as a problem and in fact the performance looks
good.

Of course we can restore the old behavior to test the folio
against some distance (gen distance or eviction distance), or push it
further to only keep the reference bit (not completely ignore the
shadow, just only keep the reference bits, if the LFU + PID still
works well without the distance), and gain more performance and bits
to use.

BTW I tried to restore the refault distance behavior for both anon and
file folios sometime ago:
https://lwn.net/Articles/945266/

For file folios it indeed looked better, anon folios seems unchanged.
But later tests showed that it doesn&#x27;t apply to all cases, and I think
something better can be used as suggested in this topic.


</pre>
</details>
</div>
<div class="thread-children">
<div class="thread-node depth-1" id="2026-02-20">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Johannes Weiner</span>
<a class="date-chip" href="../2026-02-20_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-20">2026-02-20</a>
<span class="review-tag-badge">Reviewed-by</span>
<span class="badge" style="color:#856404;background:#fff3cd">Needs Work</span>
<span class="analysis-source-badge" style="color:#004085;background:#cce5ff" title="Analysis source: LLM">LLM</span>
</div>
<div class="review-comment-text">reviewer questioned the generality of Kairui&#x27;s proposed solution for MGLRU, pointing out that it performs better with zswap but worse with disk swap, and suggested that a notion of backend speed is needed to balance anon and file reclaim</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">Are you referring to refaults on the page cache side, or swapins?

Last time we evaluated MGLRU on Meta workloads, we noticed that it
tends to do better with zswap, but worse with disk swap. It seemed to
just prefer reclaiming anon, period.

For the balancing between anon and file to work well in all
situations, it needs to have a notion of backend speed and factor in
the respective cost of misses on each side.</pre>
</details>
<div class="reply-to-label">&#8627; replying to Kairui Song</div>
<div class="review-comment-signals">Signals: requested changes</div>
</div>
</div>
<div class="thread-node depth-1">
<div class="review-comment">
<div class="review-comment-header">
<span class="review-author">Johannes Weiner</span>
<a class="date-chip" href="../2026-02-20_ollama_llama3.1-8b.html" title="First appeared in report for 2026-02-20">2026-02-20</a>
<span class="badge" style="color:#856404;background:#fff3cd">Needs Work</span>
<span class="analysis-source-badge" style="color:#004085;background:#cce5ff" title="Analysis source: LLM">LLM</span>
</div>
<div class="review-comment-text">Reviewer noted that MGLRU&#x27;s special casing of anonymous pages could lead to poor performance in workloads with large anon sets, as it assumes every refaulting anon page is hot and would fall apart when locality is low.</div>
<details class="raw-body-toggle">
<summary>Show original comment</summary>
<pre class="raw-body-text">On the face of it, both of these sounds problematic to me. Why are
anon pages special cased?

The cost of reclaiming a page is:

    reuse frequency * cost of a miss

The *type* of the page is not all that meaningful for workload
performance. The wait time is qualitatively the same.

If you assume every refaulting anon is hot, it&#x27;ll fall apart when the
anon set is huge and has little locality.</pre>
</details>
<div class="reply-to-label">&#8627; replying to Kairui Song</div>
<div class="review-comment-signals">Signals: requested changes</div>
</div>
</div>
</div>
</div>
</div>

    <footer>LKML Daily Activity Tracker</footer>
    <script>
    // When arriving via a date anchor (e.g. #2026-02-15 from a daily report),
    // scroll the anchor into view after a brief delay so layout is complete.
    (function () {
        var hash = window.location.hash;
        if (!hash) return;
        var target = document.getElementById(hash.slice(1));
        if (!target) return;
        setTimeout(function () {
            target.scrollIntoView({behavior: 'smooth', block: 'start'});
        }, 80);
    })();
    </script>
</body>
</html>