{
  "thread_id": "aZk_9iYMh2QPYNDz@gourry-fedora-PF4VCD3F",
  "subject": "Re: [PATCH 1/2] cxl/region: fix region leak when attach_target fails in cxl_add_to_region",
  "url": "https://lore.kernel.org/all/aZk_9iYMh2QPYNDz@gourry-fedora-PF4VCD3F/",
  "dates": {
    "2026-02-20": {
      "report_file": "2026-02-21_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Gregory Price",
          "summary": "Asked to disregard the patch because it uses drop_region(), which is introduced by another patch.",
          "sentiment": "neutral",
          "sentiment_signals": [],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "When a CXL memdev has a custom attach callback, cxl_add_to_region()\nshould not call device_attach() on the auto-discovered region.\n\nThe default device_attach() binds the dax driver, which may online\nmemory via dax_kmem.  The custom attach callback then has to tear down\nthe dax stack to convert the region to sysram, but dax_kmem refuses to\noffline memory during its remove path, leaving regions stuck online.\n\nSkip device_attach() when cxlmd->attach is set.  The attach callback\nis responsible for setting up the region after auto-discovery completes\n(e.g. adding it as sysram directly).\n\nSigned-off-by: Gregory Price <gourry@gourry.net>\n---\n drivers/cxl/core/region.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\ndiff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c\nindex 276046d49f88..e5edeabd9262 100644\n--- a/drivers/cxl/core/region.c\n+++ b/drivers/cxl/core/region.c\n@@ -3971,6 +3971,12 @@ int cxl_add_to_region(struct cxl_endpoint_decoder *cxled)\n \t}\n \n \tif (attach) {\n+\t\tstruct cxl_memdev *cxlmd = cxled_to_memdev(cxled);\n+\n+\t\t/* Skip device_attach if memdev has is own attach callback */\n+\t\tif (cxlmd->attach)\n+\t\t\treturn 0;\n+\n \t\t/*\n \t\t * If device_attach() fails the range may still be active via\n \t\t * the platform-firmware memory map, otherwise the driver for\n-- \n2.47.3\n\n",
          "reply_to": "",
          "message_date": "2026-02-20"
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "Fixes a region leak in cxl_add_to_region() when attach_target() fails by tracking whether the region was created and dropping it if necessary."
    },
    "2026-02-21": {
      "report_file": "2026-02-21_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "Gregory Price (author)",
          "summary": "BAH - disregard this patch, it uses drop_region which is introduced by Alejandro here: https://lore.kernel.org/linux-cxl/20260201155438.2664640-20-alejandro.lucero-palau@amd.com/",
          "sentiment": "neutral",
          "sentiment_signals": [],
          "has_inline_review": true,
          "tags_given": [],
          "analysis_source": "heuristic",
          "raw_body": "On Fri, Feb 20, 2026 at 11:30:12PM -0500, Gregory Price wrote:\n> cxl_add_to_region() ignores the return value of attach_target().  When\n> attach_target() fails (e.g. cxl_port_setup_targets() returns -ENXIO),\n> the auto-discovered region remains registered with its HPA resource\n> consumed but never reaches COMMIT state.  Subsequent region creation\n> attempts fail with -ENOSPC because the HPA range is already reserved.\n> \n> Track whether this call to cxl_add_to_region() created the region, and\n> call drop_region() on attach_target() failure to unregister it and\n> release the HPA resource.  Pre-existing regions are left alone since\n> other endpoints may already be attached.\n> \n> Signed-off-by: Gregory Price <gourry@gourry.net>\n\nBAH - disregard this patch, it uses drop_region which is introduced by\nAlejandro here:\n\nhttps://lore.kernel.org/linux-cxl/20260201155438.2664640-20-alejandro.lucero-palau@amd.com/\n\n",
          "reply_to": "",
          "message_date": "2026-02-21"
        }
      ],
      "analysis_source": "heuristic"
    }
  }
}