{
  "thread_id": "aZ3MUyOy2JgavERa@gourry-fedora-PF4VCD3F",
  "subject": "[PATCH v1 2/3] cxl/region: Factor out interleave ways setup",
  "url": "https://lore.kernel.org/all/aZ3MUyOy2JgavERa@gourry-fedora-PF4VCD3F/",
  "dates": {
    "2026-02-24": {
      "report_file": "2026-02-24_ollama_llama3.1-8b.html",
      "developer": "Gregory Price",
      "reviews": [
        {
          "author": "alejandro.lucero-palau (author)",
          "summary": "The author is addressing a concern about the need to specify the target_type parameter in the __create_region function, which was previously missing for Type2 devices. The author agrees that this change is necessary and will be included in the next version of the patch.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "acknowledged fix needed",
            "agreed to restructure"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "From: Alejandro Lucero <alucerop@amd.com>\n\nIn preparation for Type2 devices/drivers support, these next patches\nadapt the cxl region code for required Type2 functionality preserving\ncurrent functionality.\n\nAlejandro Lucero (3):\n  cxl: Make region type based on endpoint type\n  cxl/region: Factor out interleave ways setup\n  cxl/region: Factor out interleave granularity setup\n\n drivers/cxl/core/region.c | 87 +++++++++++++++++++++++++--------------\n 1 file changed, 56 insertions(+), 31 deletions(-)\n\n\nbase-commit: 6de23f81a5e08be8fbf5e8d7e9febc72a5b5f27f\n-- \n2.34.1",
          "reply_to": "",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "alejandro.lucero-palau (author)",
          "summary": "The author addressed a concern about the locking mechanism in the interleave ways store function, explaining that they will factor out a common helper from the user-sysfs region setup for interleave ways to prepare for kernel-driven region creation.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "clarification",
            "explanation"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "From: Alejandro Lucero <alucerop@amd.com>\n\nRegion creation based on Type3 devices is triggered from user space\nallowing memory combination through interleaving.\n\nIn preparation for kernel driven region creation, that is Type2 drivers\ntriggering region creation backed with its advertised CXL memory, factor\nout a common helper from the user-sysfs region setup for interleave ways.\n\nSigned-off-by: Alejandro Lucero <alucerop@amd.com>\n---\n drivers/cxl/core/region.c | 41 +++++++++++++++++++++++++--------------\n 1 file changed, 26 insertions(+), 15 deletions(-)\n\ndiff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c\nindex cac33c99fe6a..3ef4ccf1c92b 100644\n--- a/drivers/cxl/core/region.c\n+++ b/drivers/cxl/core/region.c\n@@ -485,22 +485,14 @@ static ssize_t interleave_ways_show(struct device *dev,\n \n static const struct attribute_group *get_cxl_region_target_group(void);\n \n-static ssize_t interleave_ways_store(struct device *dev,\n-\t\t\t\t     struct device_attribute *attr,\n-\t\t\t\t     const char *buf, size_t len)\n+static int set_interleave_ways(struct cxl_region *cxlr, int val)\n {\n-\tstruct cxl_region *cxlr = to_cxl_region(dev);\n \tstruct cxl_root_decoder *cxlrd = cxlr->cxlrd;\n \tstruct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;\n \tstruct cxl_region_params *p = &cxlr->params;\n-\tunsigned int val, save;\n-\tint rc;\n+\tint save, rc;\n \tu8 iw;\n \n-\trc = kstrtouint(buf, 0, &val);\n-\tif (rc)\n-\t\treturn rc;\n-\n \trc = ways_to_eiw(val, &iw);\n \tif (rc)\n \t\treturn rc;\n@@ -515,9 +507,7 @@ static ssize_t interleave_ways_store(struct device *dev,\n \t\treturn -EINVAL;\n \t}\n \n-\tACQUIRE(rwsem_write_kill, rwsem)(&cxl_rwsem.region);\n-\tif ((rc = ACQUIRE_ERR(rwsem_write_kill, &rwsem)))\n-\t\treturn rc;\n+\tlockdep_assert_held_write(&cxl_rwsem.region);\n \n \tif (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)\n \t\treturn -EBUSY;\n@@ -525,10 +515,31 @@ static ssize_t interleave_ways_store(struct device *dev,\n \tsave = p->interleave_ways;\n \tp->interleave_ways = val;\n \trc = sysfs_update_group(&cxlr->dev.kobj, get_cxl_region_target_group());\n-\tif (rc) {\n+\tif (rc)\n \t\tp->interleave_ways = save;\n+\n+\treturn rc;\n+}\n+\n+static ssize_t interleave_ways_store(struct device *dev,\n+\t\t\t\t     struct device_attribute *attr,\n+\t\t\t\t     const char *buf, size_t len)\n+{\n+\tstruct cxl_region *cxlr = to_cxl_region(dev);\n+\tunsigned int val;\n+\tint rc;\n+\n+\trc = kstrtouint(buf, 0, &val);\n+\tif (rc)\n+\t\treturn rc;\n+\n+\tACQUIRE(rwsem_write_kill, rwsem)(&cxl_rwsem.region);\n+\tif ((rc = ACQUIRE_ERR(rwsem_write_kill, &rwsem)))\n+\t\treturn rc;\n+\n+\trc = set_interleave_ways(cxlr, val);\n+\tif (rc)\n \t\treturn rc;\n-\t}\n \n \treturn len;\n }\n-- \n2.34.1",
          "reply_to": "",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "alejandro.lucero-palau (author)",
          "summary": "The author addressed a concern about the interleave granularity store function being called without acquiring the region lock, and explained that they will factor out a common helper from the user-sysfs region setup to address this issue.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "clarification",
            "explanation"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "From: Alejandro Lucero <alucerop@amd.com>\n\nRegion creation based on Type3 devices is triggered from user space\nallowing memory combination through interleaving.\n\nIn preparation for kernel driven region creation, that is Type2 drivers\ntriggering region creation backed with its advertised CXL memory, factor\nout a common helper from the user-sysfs region setup forinterleave\ngranularity.\n\nSigned-off-by: Alejandro Lucero <alucerop@amd.com>\n---\n drivers/cxl/core/region.c | 36 ++++++++++++++++++++++++------------\n 1 file changed, 24 insertions(+), 12 deletions(-)\n\ndiff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.c\nindex 3ef4ccf1c92b..aed3733490a1 100644\n--- a/drivers/cxl/core/region.c\n+++ b/drivers/cxl/core/region.c\n@@ -559,21 +559,14 @@ static ssize_t interleave_granularity_show(struct device *dev,\n \treturn sysfs_emit(buf, \"%d\\n\", p->interleave_granularity);\n }\n \n-static ssize_t interleave_granularity_store(struct device *dev,\n-\t\t\t\t\t    struct device_attribute *attr,\n-\t\t\t\t\t    const char *buf, size_t len)\n+static int set_interleave_granularity(struct cxl_region *cxlr, int val)\n {\n-\tstruct cxl_region *cxlr = to_cxl_region(dev);\n \tstruct cxl_root_decoder *cxlrd = cxlr->cxlrd;\n \tstruct cxl_decoder *cxld = &cxlrd->cxlsd.cxld;\n \tstruct cxl_region_params *p = &cxlr->params;\n-\tint rc, val;\n+\tint rc;\n \tu16 ig;\n \n-\trc = kstrtoint(buf, 0, &val);\n-\tif (rc)\n-\t\treturn rc;\n-\n \trc = granularity_to_eig(val, &ig);\n \tif (rc)\n \t\treturn rc;\n@@ -589,14 +582,33 @@ static ssize_t interleave_granularity_store(struct device *dev,\n \tif (cxld->interleave_ways > 1 && val != cxld->interleave_granularity)\n \t\treturn -EINVAL;\n \n-\tACQUIRE(rwsem_write_kill, rwsem)(&cxl_rwsem.region);\n-\tif ((rc = ACQUIRE_ERR(rwsem_write_kill, &rwsem)))\n-\t\treturn rc;\n+\tlockdep_assert_held_write(&cxl_rwsem.region);\n \n \tif (p->state >= CXL_CONFIG_INTERLEAVE_ACTIVE)\n \t\treturn -EBUSY;\n \n \tp->interleave_granularity = val;\n+\treturn 0;\n+}\n+\n+static ssize_t interleave_granularity_store(struct device *dev,\n+\t\t\t\t\t    struct device_attribute *attr,\n+\t\t\t\t\t    const char *buf, size_t len)\n+{\n+\tstruct cxl_region *cxlr = to_cxl_region(dev);\n+\tint rc, val;\n+\n+\trc = kstrtoint(buf, 0, &val);\n+\tif (rc)\n+\t\treturn rc;\n+\n+\tACQUIRE(rwsem_write_kill, rwsem)(&cxl_rwsem.region);\n+\tif ((rc = ACQUIRE_ERR(rwsem_write_kill, &rwsem)))\n+\t\treturn rc;\n+\n+\trc = set_interleave_granularity(cxlr, val);\n+\tif (rc)\n+\t\treturn rc;\n \n \treturn len;\n }\n-- \n2.34.1",
          "reply_to": "",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Dave Jiang",
          "summary": "Reviewer Dave Jiang questioned whether the patch set is dependent on a separate preparation set, requesting clarification on their relationship.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "dependency_question"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "Does this set depends on the preparation set [1] or is independent?\n\n[1]: https://lore.kernel.org/linux-cxl/20260223142633.2994082-1-alejandro.lucero-palau@amd.com/T/#t",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Dave Jiang",
          "summary": "Reviewer Dave Jiang suggested that the patch should account for auto region creation, pointing out that the current logic may not handle this case correctly.\n\nGave Reviewed-by",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "patch needs further review"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "s/is/can be/\n\nSince there's also auto region creation.",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Gregory Price",
          "summary": "Gave Reviewed-by",
          "sentiment": "positive",
          "sentiment_signals": [],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Gregory Price",
          "summary": "Gave Reviewed-by",
          "sentiment": "positive",
          "sentiment_signals": [],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Gregory Price",
          "summary": "Gave Reviewed-by",
          "sentiment": "positive",
          "sentiment_signals": [],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Gregory Price",
          "summary": "Reviewer Gregory Price noted that the additional lockdep is a nice addition and has been testing the patches, indicating they are working as expected.",
          "sentiment": "positive",
          "sentiment_signals": [
            "NEEDS_WORK"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Tested-by"
          ],
          "analysis_source": "llm",
          "raw_body": "I've been testing with these for a while - the additional lockdep is a\nnice addition.  So for series\n\nTested-by: Gregory Price <gourry@gourry.net>",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Dave Jiang",
          "summary": "Gave Reviewed-by",
          "sentiment": "positive",
          "sentiment_signals": [],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "",
          "reply_to": "alejandro.lucero-palau",
          "message_date": "2026-02-24",
          "message_id": ""
        },
        {
          "author": "Alejandro Palau",
          "summary": "reviewer confirmed that the patch applies cleanly and is independent from the others, but did not provide any technical feedback or suggestions",
          "sentiment": "neutral",
          "sentiment_signals": [
            "no specific technical concerns raised"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "Hi Dave,\n\n\nIt is independent, but it applies cleanly on top of the previous ones as \ncore/region.c is not modified by the other.\n\n\nThank you",
          "reply_to": "Dave Jiang",
          "message_date": "2026-02-24",
          "message_id": ""
        }
      ],
      "analysis_source": "llm"
    }
  }
}