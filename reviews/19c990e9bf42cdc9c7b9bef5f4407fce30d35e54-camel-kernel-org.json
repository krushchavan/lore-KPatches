{
  "thread_id": "19c990e9bf42cdc9c7b9bef5f4407fce30d35e54.camel@kernel.org",
  "subject": "Re: [PATCH v3 1/4] open: new O_REGULAR flag support",
  "url": "https://lore.kernel.org/all/19c990e9bf42cdc9c7b9bef5f4407fce30d35e54.camel@kernel.org/",
  "dates": {
    "2026-02-18": {
      "report_file": "2026-02-18_ollama_llama3.1-8b.html",
      "developer": "Jeff Layton",
      "reviews": [
        {
          "author": "Jeff Layton",
          "summary": "Reviewer Jeff Layton noted that nfs_atomic_open() might not work efficiently with the new O_REGULAR flag, but after reevaluating, he thinks it will work without changes; however, he suggested an optimization opportunity where if open_context() returns -EISDIR or similar, the function can immediately return an error when O_REGULAR is set",
          "sentiment": "neutral",
          "sentiment_signals": [
            "requested optimization",
            "potential inefficiency"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "I was thinking nfs_atomic_open().\n\nLooking now, I think it might actually work OK without changes. It just\nmight not be terribly efficient about it.\n\nIf the open_context() call returns -EISDIR or similar, then you really\ndon't need to do the call to nfs_lookup() and the like. You can just\nreturn an immediate error when O_REGULAR is set since you know it's not\nsuitable to be opened.",
          "reply_to": "Dorjoy Chowdhury",
          "message_date": "2026-02-18"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer noted that while most cases will fall back to finish_no_open(), there may be opportunities for optimization, similar to how he mentioned optimizing NFS, and requested a deeper dive and testing of these cases.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "optimization",
            "deeper dive"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Note that this was just a cursory look. Someone will need to do a\ndeeper dive and test these cases.\n\nI think most will end up working ok, since most fall back to doing a\nfinish_no_open(). There may be opportunities to optimize some of these\ncases though (similarly to how I mentioned with NFS).\n-- \nJeff Layton <jlayton@kernel.org>",
          "reply_to": "Dorjoy Chowdhury",
          "message_date": "2026-02-18"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer Jeff Layton noted that POSIX flags like O_REGULAR should not be sent in NFSv4 requests, as they have their own set of flags and O_REGULAR is already implied in an OPEN call on the wire.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "flag",
            "NFSv4"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "You shouldn't. We don't send POSIX flags in NFSv4 requests. It has its\nown set of flags. In the case of NFSv4, O_REGULAR is already implied in\nan OPEN call on the wire. OPEN only operates on regular files.",
          "reply_to": "Dorjoy Chowdhury",
          "message_date": "2026-02-18"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer noted that when a valid dentry exists, the O_REGULAR flag can be checked without calling ->open(), and suggested re-evaluating the code to avoid unnecessary calls.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "Probably not.\n\nThe main thing to keep in mind is that ->open is used when we already\nhave a dentry for the target of the open. ->atomic_open is used when we\ndon't have one yet or the one we have has failed revalidation.\n\nIf you have a valid dentry, then you should be able to satisfy the\nO_REGULAR check without having to call into ->open at all.\n-- \nJeff Layton <jlayton@kernel.org>",
          "reply_to": "Dorjoy Chowdhury",
          "message_date": "2026-02-18"
        }
      ],
      "analysis_source": "llm-per-reviewer"
    },
    "2026-01-29": {
      "report_file": "2026-02-18_ollama_llama3.1-8b.html",
      "developer": "Jeff Layton",
      "reviews": [
        {
          "author": "Christian Brauner",
          "summary": "Reviewer Christian Brauner expressed concerns about adding O_REGULAR flag support outside of openat2(), suggesting it should be prefixed with OPENAT2_ and not made exclusive with O_DIRECTORY, and instead proposed using EFTYPE as the errno code.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes",
            "suggested improvements"
          ],
          "has_inline_review": true,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "Yeah, we shouldn't add support for this outside of openat2(). We also\nshouldn't call this OEXT_* or O2_*. Let's just follow the pattern where\nwe prefix the flag space with the name of the system call\nOPENAT2_REGULAR.\n\nThere's also no real need to make O_DIRECTORY exclusive with\nOPENAT2_REGULAR. Callers could legimitately want to open a directory or\nregular file but not anything else. If someone wants to operate on a\nwhole filesystem tree but only wants to interact with regular files and\ndirectories and ignore devices, sockets, fifos etc it's very handy to\njust be able to set both in flags.\n\nFrankly, this shouldn't be a flag at all but we already have O_DIRECTORY\nin there so no need to move this into a new field.\n\nAdd EFTYPE as the errno code. Some of the bsds including macos already\nhave that.",
          "reply_to": "Dorjoy Chowdhury",
          "message_date": "2026-01-29"
        },
        {
          "author": "Christian Brauner",
          "summary": "Reviewer Christian Brauner noted that the patch's intention to block O_REGULAR for ->atomic_open:: is problematic because it may break filesystems that handle this case correctly, and suggested bypassing ->atomic_open:: for OPENAT2_REGULAR without O_CREAT or implementing a protocol extension.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes",
            "concern about potential breakage"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "So I think you're proposing two separate things or there's a typo:\n\n(1) blocking O_DIRECTORY for ->atomic_open::\n(2) blocking O_REGULAR for ->atomic_open::\n\nThe (1) point implies that O_DIRECTORY currently doesn't work correctly\nwith atomic open for all filesystems.\n\nEver since 43b450632676 (\"open: return EINVAL for O_DIRECTORY |\nO_CREAT\") O_DIRECTORY with O_CREAT is blocked. It was accidently allowed\nand completely broken before that.\n\nFor O_DIRECTORY without O_CREAT the kernel will pass that down through\n->atomic_open:: to the filesystem.\n\nThe worry that I see is that a network filesystem via ->atomic_open::\nsomehow already called open on the server side on something that wasn't\na directory. At that point the damage such as side-effects from device\nopening is already done.\n                                    \nBut I suspect that every filesystem implementing ->atomic_open:: just\ndoes finish_no_open() and punts to the VFS for the actual open. And the\nVFS will catch it in do_open() for it actually opens the file. So the\nonly real worry for O_DIRECTORY I see is that there's an fs that handles\nit wrong.\n\nFor (2) it is problematic as there surely are filesystems with\n->atomic_open:: that do handle the ~O_CREAT case and return with\nFMODE_OPENED. So that'll be problematic if the intention is to not\ntrigger an actual open on a non-regular file such as a\ndevice/socket/fifo etc. before the VFS had a chance to validate what's\ngoing on.\n\nSo I'm not excited about having this 70% working and punting on\n->atomic_open:: waiting for someone to fix this. One option would be to\nbypass ->atomic_open:: for OPENAT2_REGULAR without O_CREAT and fallback\nto racy and pricy lookup + open for now. How problematic would that be?\nIf possible I'd prefer this a lot over merging something that works\nhalf-way.\n\nI guess to make that really work you'd need some protocol extension?",
          "reply_to": "Jeff Layton",
          "message_date": "2026-01-29"
        },
        {
          "author": "Jeff Layton",
          "summary": "reviewer noted that sending an immediate close would have unintended consequences",
          "sentiment": "neutral",
          "sentiment_signals": [
            "NEUTRAL",
            "side effects"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Exactly. I guess you could send an immediate close, but that's not\nwithout side effects.",
          "reply_to": "Christian Brauner",
          "message_date": "2026-01-29"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer noted that O_REGULAR flag support may need to be handled differently in various file systems, specifically mentioning NFS and cifs as potential issues.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes",
            "potential issues"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "For NFS, I think we're OK. The OPEN call on NFSv4 only works for\nregular files, so it should be able to handle O_REGULAR. We just need\nto rejigger the error handling when it's set (just return an error\ninstead of doing the open of a directory or whatever it is).\n\nThe others (at a quick glance):\n\ncifs: I don't see a way to specify an O_REGULAR equivalent to the\nSMB2_CREATE call and it looks like it can create directories. Maybe\nSteveF (cc'ed) knows if this is possible?\n\nceph: I think CEPH_MDS_OP_OPEN might only work for files, in which case\nO_REGULAR can probably be supported similarly to NFS.\n\nfuse: probably ok? Does finish_no_open() in most cases. May depend on\nthe userland driver though.\n\ngfs2: is ok, it just does finish_no_open() in most cases anyway\n\nvboxsf: does finish_no_open on non-creates, so you could probably just\npunt to that if O_REGULAR is set.\n\nSo, it's probably possible to do this across the board. I'm not sure\nabout cifs though.\n-- \nJeff Layton <jlayton@kernel.org>",
          "reply_to": "Christian Brauner",
          "message_date": "2026-01-29"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer Jeff Layton pointed out that SMB2 has an existing flag (FILE_NON_DIRECTORY_FILE) that enforces the same behavior as O_REGULAR, and suggested considering its implications on file types like directories, named pipes, and printer files.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "considering existing SMB2 flag",
            "implications on file types"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "SMB2 does have this flag:\n\nFILE_NON_DIRECTORY_FILE 0x00000040\n\nIf the name of the file being created or opened matches with an\nexisting directory file, the server MUST fail the request with\nSTATUS_FILE_IS_A_DIRECTORY. This flag MUST NOT be used with\nFILE_DIRECTORY_FILE or the server MUST fail the request with\nSTATUS_INVALID_PARAMETER.\n\nSMB2 can also present named pipes and printer files. Not sure if there\nis a way to exclude those with this.",
          "reply_to": "",
          "message_date": "2026-01-29"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer noted that the O_REGULAR flag does not prevent opening directories, and requested a review of the MDS (Memory Description Structure) code to determine if it can be done in a non-racy way.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "requested changes"
          ],
          "has_inline_review": true,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Actually I'm wrong here. That op can open a directory. We'll need\nsomeone to look at the MDS code and tell us whether this can be done in\na non-racy way.",
          "reply_to": "",
          "message_date": "2026-01-29"
        },
        {
          "author": "Jeff Layton",
          "summary": "Reviewer noted that O_DIRECTORY flag handling is not broken on other file systems, specifically mentioning NFS as an example, and expressed no concerns about the patch",
          "sentiment": "neutral",
          "sentiment_signals": [
            "no specific technical issue raised"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "It looks like NFS at least handles O_DIRECTORY properly. I don't have\nany reason to believe that O_DIRECTORY handling is broken on the\nothers.",
          "reply_to": "Christian Brauner",
          "message_date": "2026-01-29"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "Author agrees that OPENAT2_REGULAR is a better option than OEXT_*/O2_* options, but asks if it should be defined outside the 32-bit range to avoid conflicts with existing flags and only need to be defined in include/uapi/asm-generic/fcntl.h.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "clarifying question",
            "request for feedback"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Thanks for the feedback. I agree that OPENAT2_REGULAR is better than\nthe other OEXT_*/O2_* options. Right now in the patch, the O_REGULAR\ntook the next slot in all the fcntl files. Should OPENAT2_REGULAR be a\nbit outside of the 32bits? That way it won't take any of the regular\nO_* bits and we would only need to define it in\ninclude/uapi/asm-generic/fcntl.h file and not need it in\narch/*/fcntl.h files. What do you think?",
          "reply_to": "Christian Brauner",
          "message_date": "2026-01-29"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "Author acknowledged a need to address Christian Brauner's feedback about the O_REGULAR flag's interaction with other flags like O_CREAT, agreeing to fix this in v4.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "acknowledged a need for revision",
            "agreed to fix"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Great suggestion. Will fixup in v4 submission.\n\nRegards,\nDorjoy",
          "reply_to": "Christian Brauner",
          "message_date": "2026-01-29"
        },
        {
          "author": "Aleksa Sarai",
          "summary": "Reviewer noted that using a bitmask of S_IFMT to reject opening certain file types would be similar in spirit to O_NOFOLLOW, but pointed out that S_IFBLK is a combination of S_IFCHR and S_IFDIR, which complicates the idea.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "NEUTRAL"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "You could even say O_NOFOLLOW is kinda like that too.\n\nIn my other mail I proposed a bitmask of S_IFMT to reject opening (which\nwould let you allow FIFOs and regular files but block devices, etc).\nUnfortunately I forgot that S_IFBLK is S_IFCHR|S_IFDIR. This isn't fatal\nto the idea but it kinda sucks. Grr.",
          "reply_to": "Christian Brauner",
          "message_date": "2026-01-29"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "Author agrees that introducing a new how->sfmt_allow field with separate bits for file types is a good suggestion, but expresses concern about the complexity of using different bits as an API.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "acknowledges feedback",
            "expresses concern"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "It is a good suggestion. I guess we can still introduce a new\nhow->sfmt_allow field and have new bits (instead of keeping in sync\nwith S_IF* ones) that allow types and just start with regular file\nallow bit for now, right? But I guess it would be cumbersome for users\nas an api to use different bits?\n\nRegards,\nDorjoy",
          "reply_to": "Aleksa Sarai",
          "message_date": "2026-01-29"
        }
      ],
      "analysis_source": "llm-per-reviewer"
    },
    "2026-02-19": {
      "report_file": "2026-02-18_ollama_llama3.1-8b.html",
      "developer": "Jeff Layton",
      "reviews": [
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "Author is seeking clarification on which code path the O_REGULAR flag's error handling should occur in, specifically asking if it's inode_operations.atomic_open or file_operations.open.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "clarifying question"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Thank you for the details. Do you remember which codepath this is? Is\nthis the inode_operations.atomic_open codepath or file_operations.open\ncodepath? I am a bit confused also about where exactly the error\nhandling that needs to be done.",
          "reply_to": "Jeff Layton",
          "message_date": "2026-02-19"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "The author is clarifying that the atomic_open code paths are being addressed, specifically mentioning finish_no_open in inode_operations.atomic_open.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "clarification",
            "question"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "These are all inode_operations.atomic_open code paths, right? Because\nyou mentioned finish_no_open and I see finish_no_open in the\natomic_open code paths as opposed to file_operations.open code paths.\n\nRegards,\nDorjoy",
          "reply_to": "Jeff Layton",
          "message_date": "2026-02-19"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "The author acknowledges that O_REGULAR needs to be handled as an unknown flag in addition to NFS, and is considering this for future revisions.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "acknowledges a fix is needed"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Right. And I guess we don't need to worry about O_REGULAR being an\nunknown flag when it gets sent to the server (not only for NFS / but\nothers as well)?",
          "reply_to": "Jeff Layton",
          "message_date": "2026-02-19"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "Author acknowledged that O_REGULAR flag handling is needed in additional filesystems and asked if modifying corresponding file_operations.open code paths is also required.",
          "sentiment": "needs_work",
          "sentiment_signals": [
            "acknowledged a fix is needed",
            "asked for clarification"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "I can try to look into these and see if I can implement handling for\nO_REGULAR flag for these filesystems in the atomic_open code paths.\nThanks for the details.\n\nWill I need to modify the corresponding file_operations.open code\npaths as well along with atomic_open code paths?\n\nRegards,\nDorjoy",
          "reply_to": "Jeff Layton",
          "message_date": "2026-02-19"
        },
        {
          "author": "Dorjoy Chowdhury (author)",
          "summary": "Author acknowledged Jeff's feedback and expressed gratitude, indicating no further action is needed.",
          "sentiment": "positive",
          "sentiment_signals": [
            "acknowledgment",
            "gratitude"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "Understood. Thanks!\n\nRegards,\nDorjoy",
          "reply_to": "Jeff Layton",
          "message_date": "2026-02-19"
        }
      ],
      "analysis_source": "llm-per-reviewer"
    }
  }
}