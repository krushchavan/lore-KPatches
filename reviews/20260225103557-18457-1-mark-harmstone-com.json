{
  "thread_id": "20260225103557.18457-1-mark@harmstone.com",
  "subject": "[PATCH] btrfs: fix use-after-free in move_existing_remap()",
  "url": "https://lore.kernel.org/all/20260225103557.18457-1-mark@harmstone.com/",
  "dates": {
    "2026-02-25": {
      "report_file": "2026-02-25_ollama_llama3.1-8b.html",
      "developer": "Mark Harmstone",
      "reviews": [
        {
          "author": "Johannes Thumshirn",
          "summary": "Suggested moving the call to btrfs_put_block_group() to the end of the function, eliminating the need for an additional lookup of the block group further down.",
          "sentiment": "neutral",
          "sentiment_signals": [
            "WAITING_FOR_REVIEW"
          ],
          "has_inline_review": false,
          "tags_given": [],
          "analysis_source": "llm",
          "raw_body": "On 2/25/26 11:36 AM, Mark Harmstone wrote:\r\n> Fix a potential use-after-free in move_existing_remap(): we're calling\r\n> btrfs_put_block_group() on dest_bg, then passing it to\r\n> btrfs_add_block_group_free_space() a few lines later.\r\n>\r\n> Link: https://lore.kernel.org/linux-btrfs/20260125123908.2096548-1-clm@meta.com/\r\n> Reported-by: Chris Mason <clm@fb.com>\r\n> Fixes: bbea42dfb91f (\"btrfs: move existing remaps before relocating block group\")\r\n> Signed-off-by: Mark Harmstone <mark@harmstone.com>\r\n> ---\r\n>   fs/btrfs/relocation.c | 7 +++++--\r\n>   1 file changed, 5 insertions(+), 2 deletions(-)\r\n>\r\n> diff --git a/fs/btrfs/relocation.c b/fs/btrfs/relocation.c\r\n> index cc80760ba5e7..5a8644667620 100644\r\n> --- a/fs/btrfs/relocation.c\r\n> +++ b/fs/btrfs/relocation.c\r\n> @@ -4295,14 +4295,17 @@ static int move_existing_remap(struct btrfs_fs_info *fs_info,\r\n>   \tbg_needs_free_space = test_bit(BLOCK_GROUP_FLAG_NEEDS_FREE_SPACE,\r\n>   \t\t\t\t       &dest_bg->runtime_flags);\r\n>   \tmutex_unlock(&dest_bg->free_space_lock);\r\n> -\tbtrfs_put_block_group(dest_bg);\r\n>   \r\n>   \tif (bg_needs_free_space) {\r\n>   \t\tret = btrfs_add_block_group_free_space(trans, dest_bg);\r\n> -\t\tif (unlikely(ret))\r\n> +\t\tif (unlikely(ret)) {\r\n> +\t\t\tbtrfs_put_block_group(dest_bg);\r\n>   \t\t\tgoto end;\r\n> +\t\t}\r\n>   \t}\r\n>   \r\n> +\tbtrfs_put_block_group(dest_bg);\r\n> +\r\n>   \tret = btrfs_remove_from_free_space_tree(trans, dest_addr, dest_length);\r\n>   \tif (unlikely(ret)) {\r\n>   \t\tbtrfs_remove_from_free_space_tree(trans, new_addr, dest_length);\r\nWhy can't you move the put to the end of the function and skip the new \r\nlookup of the BG further down the function?\r\n",
          "reply_to": "Mark Harmstone",
          "message_date": "2026-02-25",
          "message_id": ""
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a potential use-after-free bug in the btrfs move_existing_remap() function by moving the call to btrfs_put_block_group() to the end of the function, eliminating the need for an additional lookup of the block group further down."
    }
  }
}