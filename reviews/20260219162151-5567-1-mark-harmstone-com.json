{
  "thread_id": "20260219162151.5567-1-mark@harmstone.com",
  "subject": "[PATCH] btrfs: fix transaction handle leaks in btrfs_last_identity_remap_gone()",
  "url": "https://lore.kernel.org/all/20260219162151.5567-1-mark@harmstone.com/",
  "dates": {
    "2026-02-19": {
      "report_file": "2026-02-19_ollama_llama3.1-8b.html",
      "developer": "Mark Harmstone",
      "reviews": [
        {
          "author": "Filipe Manana",
          "summary": "Noted that the fix is already present in for-next and Linus' tree, so added a Fixes tag to reference the existing commit. Provided a Reviewed-by tag.",
          "sentiment": "positive",
          "sentiment_signals": [
            "acknowledged"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "On Thu, Feb 19, 2026 at 4:24â€¯PM Mark Harmstone <mark@harmstone.com> wrote:\n>\n> btrfs_abort_transaction(), unlike btrfs_commit_transaction(), doesn't\n> also free the transaction handle. Fix the instances in\n> btrfs_last_identity_remap_gone() where we're also leaking the\n> transaction on abort.\n>\n> This fixes a bug introduced in \"btrfs: handle deletions from remapped\n> block group\" in for-next.\n\nIn for-next and in Linus' tree already, commit\n979e1dc3d69e4c825eec05d05d9567b251f6ec23.\nOnce you see David's pull request to Linus, you can assume the commit\nID is stable and it will match the commit ID in Linus' tree once\nmerged.\n\nSo we can, and should, add here:\n\nFixes: 979e1dc3d69e (\"btrfs: handle deletions from remapped block group\")\n\nWith that added:\n\nReviewed-by: Filipe Manana <fdmanana@suse.com>\n\nThanks.\n\n>\n> Signed-off-by: Mark Harmstone <mark@harmstone.com>\n> Suggested-by: Chris Mason <clm@fb.com>\n> Link: https://lore.kernel.org/linux-btrfs/20260125125129.2245240-1-clm@meta.com/\n> ---\n>  fs/btrfs/relocation.c | 3 +++\n>  1 file changed, 3 insertions(+)\n>\n> diff --git a/fs/btrfs/relocation.c b/fs/btrfs/relocation.c\n> index 8a8a66112d42..f2abc5d625c1 100644\n> --- a/fs/btrfs/relocation.c\n> +++ b/fs/btrfs/relocation.c\n> @@ -4715,6 +4715,7 @@ int btrfs_last_identity_remap_gone(struct btrfs_chunk_map *chunk_map,\n>         ret = btrfs_remove_dev_extents(trans, chunk_map);\n>         if (unlikely(ret)) {\n>                 btrfs_abort_transaction(trans, ret);\n> +               btrfs_end_transaction(trans);\n>                 return ret;\n>         }\n>\n> @@ -4724,6 +4725,7 @@ int btrfs_last_identity_remap_gone(struct btrfs_chunk_map *chunk_map,\n>                 if (unlikely(ret)) {\n>                         mutex_unlock(&trans->fs_info->chunk_mutex);\n>                         btrfs_abort_transaction(trans, ret);\n> +                       btrfs_end_transaction(trans);\n>                         return ret;\n>                 }\n>         }\n> @@ -4742,6 +4744,7 @@ int btrfs_last_identity_remap_gone(struct btrfs_chunk_map *chunk_map,\n>         ret = remove_chunk_stripes(trans, chunk_map, path);\n>         if (unlikely(ret)) {\n>                 btrfs_abort_transaction(trans, ret);\n> +               btrfs_end_transaction(trans);\n>                 return ret;\n>         }\n>\n> --\n> 2.52.0\n>\n>\n\n",
          "reply_to": "Mark Harmstone",
          "message_date": "2026-02-19"
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch fixes a bug in the Btrfs filesystem where transaction handles are not properly released on abort, leading to memory leaks. The fix involves adding calls to btrfs_end_transaction() in specific error paths within the btrfs_last_identity_remap_gone() function."
    }
  }
}