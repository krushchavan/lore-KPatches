{
  "thread_id": "20260219163313.15888-1-mark@harmstone.com",
  "subject": "[PATCH] btrfs: add check in remove_range_from_remap_tree() for a NULL block group",
  "url": "https://lore.kernel.org/all/20260219163313.15888-1-mark@harmstone.com/",
  "dates": {
    "2026-02-19": {
      "report_file": "2026-02-19_ollama_llama3.1-8b.html",
      "developer": "Mark Harmstone",
      "reviews": [
        {
          "author": "Filipe Manana",
          "summary": "Suggested using unlikely() to handle the unexpected NULL return from btrfs_lookup_block_group(), and added a Fixes: tag referencing the original bug-fix patch. Provided Reviewed-by tag.",
          "sentiment": "positive",
          "sentiment_signals": [
            "USEFUL_SUGGESTION"
          ],
          "has_inline_review": false,
          "tags_given": [
            "Reviewed-by"
          ],
          "analysis_source": "llm",
          "raw_body": "On Thu, Feb 19, 2026 at 4:33â€¯PM Mark Harmstone <mark@harmstone.com> wrote:\n>\n> Add a check in remove_range_from_remap_tree() after we call\n> btrfs_lookup_block_group(), to check if it is NULL. This shouldn't\n> happen, but if it does we at least get an error rather than a segfault.\n>\n> This fixes a bug introduced in the patch \"btrfs: handle deletions from\n> remapped block group\" in for-next.\n\nSame comment as for the other patch, that change is already in Linus'\ntree, so we can and should add here a:\n\nFixes: 979e1dc3d69e (\"btrfs: handle deletions from remapped block group\")\n\n\n>\n> Signed-off-by: Mark Harmstone <mark@harmstone.com>\n> Suggested-by: Chris Mason <clm@fb.com>\n> Link: https://lore.kernel.org/linux-btrfs/20260125125129.2245240-1-clm@meta.com/\n> ---\n>  fs/btrfs/relocation.c | 3 +++\n>  1 file changed, 3 insertions(+)\n>\n> diff --git a/fs/btrfs/relocation.c b/fs/btrfs/relocation.c\n> index f2abc5d625c1..679e551707f5 100644\n> --- a/fs/btrfs/relocation.c\n> +++ b/fs/btrfs/relocation.c\n> @@ -6003,6 +6003,9 @@ static int remove_range_from_remap_tree(struct btrfs_trans_handle *trans,\n>                 struct btrfs_block_group *dest_bg;\n>\n>                 dest_bg = btrfs_lookup_block_group(fs_info, new_addr);\n> +               if (!dest_bg)\n> +                       return -EUCLEAN;\n\nSince this is a EUCLEAN and highly unexpected, we can use unlikely\nhere, see: https://btrfs.readthedocs.io/en/latest/dev/Development-notes.html\n\nWith those two changes:\n\nReviewed-by: Filipe Manana <fdmanana@suse.com>\n\nThanks.\n\n> +\n>                 adjust_block_group_remap_bytes(trans, dest_bg, -overlap_length);\n>                 btrfs_put_block_group(dest_bg);\n>                 ret = btrfs_add_to_free_space_tree(trans,\n> --\n> 2.52.0\n>\n>\n\n",
          "reply_to": "",
          "message_date": "2026-02-19"
        }
      ],
      "analysis_source": "llm",
      "patch_summary": "This patch adds a check in the remove_range_from_remap_tree() function to handle the case where btrfs_lookup_block_group() returns NULL, preventing potential segfaults and returning an error instead."
    }
  }
}